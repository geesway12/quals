<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2196f3">
  <title>Focus Group Discussion - QualiData</title>
  <!-- Suppress missing icon warnings -->
  <link rel="apple-touch-icon" sizes="180x180" href="/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/logo.png">
  <link rel="shortcut icon" href="/logo.png">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('assets/collaboration.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.1;
      z-index: -1;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      padding-top: 1rem;
      padding-bottom: 1rem;
      min-height: 80px;
    }

    .partner-logos {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
      margin-right: 2rem;
    }

    .partner-logos img {
      height: 36px;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .partner-logos img:hover {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .partner-logos {
        display: none;
      }
    }

    .main-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin: 2rem auto;
      padding: 2rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      max-width: 1200px;
    }

    .btn-back {
      background: linear-gradient(135deg, #6c757d, #495057);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      transform: scale(1.05);
      color: white;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .card-header {
      border-radius: 15px 15px 0 0 !important;
      border: none;
    }

    .recording-controls {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      margin: 2rem 0;
    }

    .recording-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      border-radius: 50px;
      padding: 1rem 2rem;
      margin: 0.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .recording-btn:hover {
      background: white;
      color: #ff9800;
    }

    .recording-btn.recording {
      background: #fff;
      color: #ff9800;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .participant-tracker {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #ff9800;
      box-shadow: 0 0 0 0.25rem rgba(255, 152, 0, 0.25);
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      border: none;
      border-radius: 25px;
      padding: 0.75rem 2rem;
    }

    @media (max-width: 768px) {
      .main-content {
        margin: 1rem;
        padding: 1rem;
      }
      
      .recording-controls {
        padding: 1.5rem;
      }
      
      .recording-btn {
        display: block;
        width: 100%;
        margin: 0.5rem 0;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container d-flex align-items-center">
      <a href="index.html" class="btn-back me-3">
        <i class="bi bi-arrow-left me-2"></i>Back
      </a>
      <img src="/logo.png" alt="QualiData Logo" style="height:40px; margin-right:12px;">
      <span class="navbar-brand fw-bold text-primary mb-0">
        Focus Group Discussion
      </span>
      
      <!-- Partner Logos -->
      <div class="partner-logos">
        <img src="assets/uhas.jpg" alt="UHAS" title="University of Health and Allied Sciences">
        <img src="assets/hpi.png" alt="HPI" title="Hasso Plattner Institute">
        <img src="assets/ghs.jpg" alt="GHS" title="Ghana Health Service">
        <img src="assets/cpmr.png" alt="CPMR" title="Centre for Plant Medicine Research">
      </div>
    </div>
  </nav>

  <div class="main-content" style="margin-top: 120px;">
    <div class="container-fluid">
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-4" id="fgdTabNav" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setupPanel" type="button" role="tab">Setup</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendancePanel" type="button" role="tab">Attendance</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="guide-tab" data-bs-toggle="tab" data-bs-target="#guidePanel" type="button" role="tab">Group Guide</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="recording-tab" data-bs-toggle="tab" data-bs-target="#recordingPanel" type="button" role="tab">Recording</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notesPanel" type="button" role="tab">Session Notes</button>
        </li>
      </ul>

      <div class="tab-content" id="fgdTabContent">
        <!-- Setup Panel -->
        <div class="tab-pane fade show active" id="setupPanel" role="tabpanel">
          <div class="card mb-4">
            <div class="card-header bg-warning text-white">
              <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Session Setup</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="sessionDate" class="form-label">Session Date & Time</label>
                  <input type="datetime-local" class="form-control" id="sessionDate" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="sessionLocation" class="form-label">Location</label>
                  <input type="text" class="form-control" id="sessionLocation" placeholder="e.g., Conference Room A">
                </div>
                <!-- Facilitator field removed as requested -->
                <div class="col-md-6 mb-3">
                  <label for="expectedParticipants" class="form-label">Expected Participants</label>
                  <input type="number" class="form-control" id="expectedParticipants" min="3" max="12" value="6">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="fgdGroup" class="form-label">Select Group</label>
                  <select class="form-select" id="fgdGroup">
                    <option value="Patient">Hypertensive Patients</option>
                    <option value="Clinician">Clinicians</option>
                    <option value="Herbalist">Herbal Practitioners</option>
                    <option value="Caregiver">Caregivers</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Panel -->
        <div class="tab-pane fade" id="attendancePanel" role="tabpanel">
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Participant Attendance</h5>
            </div>
            <div class="card-body">
              <div class="participant-tracker">
                <div class="row mb-3">
                  <div class="col-md-4">
                    <input type="text" class="form-control" id="participantId" placeholder="Participant ID">
                  </div>
                  <div class="col-md-3">
                    <input type="text" class="form-control" id="participantAge" placeholder="Age">
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" id="participantGender">
                      <option value="">Gender</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn btn-primary w-100" onclick="addParticipant()">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="row mb-2">
                  <div class="col-md-4">
                    <select class="form-select" id="participantFilter" onchange="updateParticipantsList()">
                      <option value="">Show All</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                </div>
                <div id="participantsList">
                  <p class="text-muted">No participants added yet</p>
                </div>
              </div>
            </div>
          </div>
          <!-- Eligible Participants Selection -->
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="bi bi-people me-2"></i>Select Eligible Participants from Screening</h5>
            </div>
            <div class="card-body">
              <div id="eligibleParticipantsList">
                <p class="text-muted">Loading eligible participants...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Guide Panel -->
        <div class="tab-pane fade" id="guidePanel" role="tabpanel">
          <!-- All group guides, only one shown at a time by JS -->
          <div class="card mb-4" id="guidePatient">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Hypertensive Patients Focus Group Guide</h5>
            </div>
            <div class="card-body">
              <!-- ...existing guidePatient content... -->
              <h5 class="mb-3 text-primary">Icebreaker</h5>
              <p><em>“Please tell us your name and one thing you do regularly to keep your blood pressure under control.”</em></p>
              <h5 class="mb-3 text-primary">Group Norms</h5>
              <ul>
                <li>Speak one at a time</li>
                <li>Everyone’s views are respected</li>
                <li>You can choose not to answer any question</li>
                <li>What we share here stays confidential</li>
              </ul>
              <h5 class="mb-3 text-primary">Discussion Prompts</h5>
              <ul>
                <li><strong>Diagnosis and Treatment Journey</strong>
                  <ul>
                    <li>How did you first find out you had high blood pressure?</li>
                    <li>What was your first reaction or thought at the time?</li>
                    <li>What kinds of treatments have you tried since then (e.g., hospital drugs, herbs, prayer, others)?</li>
                  </ul>
                </li>
                <li><strong>Perceptions and Beliefs</strong>
                  <ul>
                    <li>In your opinion, what causes or worsens high blood pressure?</li>
                    <li>What things have worked best for you in managing your BP?</li>
                  </ul>
                </li>
                <li><strong>Integration Thoughts</strong>
                  <ul>
                    <li>Have you ever used both hospital medicine and herbal remedies together?</li>
                    <li>Would you feel safe or confident if a doctor and herbalist worked together to support you?</li>
                  </ul>
                </li>
                <li><strong>Personalisation and Tools</strong>
                  <ul>
                    <li>Do you feel your treatment is based on your specific needs, or is it the same for everyone?</li>
                    <li>Would you use a mobile phone app to help track what works best for you?</li>
                  </ul>
                </li>
              </ul>
              <h5 class="mb-3 text-primary">Optional Activity</h5>
              <div class="row g-3 mb-3" id="trustOptions">
                <div class="col-md-2 col-6">
                  <div class="card text-center option-card" data-option="hospital drugs">
                    <div class="card-body py-3 position-relative">
                      <i class="bi bi-capsule-pill display-5 text-primary"></i>
                      <div class="fw-bold mt-2">Hospital Drugs</div>
                      <span class="checkmark-overlay" style="display:none; position:absolute; top:10px; right:10px; font-size:2rem; color:#28a745;"><i class="bi bi-check-circle-fill"></i></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-6">
                  <div class="card text-center option-card" data-option="herbs">
                    <div class="card-body py-3 position-relative">
                      <i class="bi bi-flower2 display-5 text-success"></i>
                      <div class="fw-bold mt-2">Herbs</div>
                      <span class="checkmark-overlay" style="display:none; position:absolute; top:10px; right:10px; font-size:2rem; color:#28a745;"><i class="bi bi-check-circle-fill"></i></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-6">
                  <div class="card text-center option-card" data-option="prayer">
                    <div class="card-body py-3 position-relative">
                      <i class="bi bi-heart display-5 text-warning"></i>
                      <div class="fw-bold mt-2">Prayer</div>
                      <span class="checkmark-overlay" style="display:none; position:absolute; top:10px; right:10px; font-size:2rem; color:#28a745;"><i class="bi bi-check-circle-fill"></i></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-6">
                  <div class="card text-center option-card" data-option="exercise">
                    <div class="card-body py-3 position-relative">
                      <i class="bi bi-bicycle display-5 text-info"></i>
                      <div class="fw-bold mt-2">Exercise</div>
                      <span class="checkmark-overlay" style="display:none; position:absolute; top:10px; right:10px; font-size:2rem; color:#28a745;"><i class="bi bi-check-circle-fill"></i></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-6">
                  <div class="card text-center option-card" data-option="diet change">
                    <div class="card-body py-3 position-relative">
                      <i class="bi bi-egg-fried display-5 text-danger"></i>
                      <div class="fw-bold mt-2">Diet Change</div>
                      <span class="checkmark-overlay" style="display:none; position:absolute; top:10px; right:10px; font-size:2rem; color:#28a745;"><i class="bi bi-check-circle-fill"></i></span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <strong>Ask:</strong> “Which of these do you trust—and why?”
                <div class="mt-2">
                  <span class="text-muted">Tap cards to select multiple. Enter all reasons below.</span>
                </div>
                <div class="mt-2">
                  <span id="trustChoiceCounter" class="badge bg-primary">0 selected</span>
                </div>
                <textarea id="trustChoiceReasons" class="form-control mt-2" rows="2" placeholder="Enter all reasons for your selected choices..."></textarea>
                <button id="saveTrustChoices" class="btn btn-outline-primary mt-2">Save Choices</button>
                <button id="exportTrustChoices" class="btn btn-outline-success mt-2 ms-2">Export Choices</button>
                <div id="trustChoicesSaved" class="text-success mt-2" style="display:none;">Choices saved!</div>
              </div>
              <h5 class="mb-3 text-primary">Closing</h5>
              <p><em>“Thank you all for your time and openness. What advice do you have for us to make this study helpful for people like you?”</em></p>
            </div>
          </div>
          <div class="card mb-4" id="guideClinician" style="display:none;">
            <!-- ...existing guideClinician content... -->
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Clinicians Focus Group Guide</h5>
            </div>
            <div class="card-body">
              <!-- ...existing guideClinician content... -->
              <!-- ...content omitted for brevity... -->
            </div>
          </div>
          <div class="card mb-4" id="guideHerbalist" style="display:none;">
            <!-- ...existing guideHerbalist content... -->
            <div class="card-header bg-success text-white">
              <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Herbal Practitioners Focus Group Guide</h5>
            </div>
            <div class="card-body">
              <!-- ...existing guideHerbalist content... -->
              <!-- ...content omitted for brevity... -->
            </div>
          </div>
          <div class="card mb-4" id="guideCaregiver" style="display:none;">
            <!-- ...existing guideCaregiver content... -->
            <div class="card-header bg-warning text-white">
              <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Caregivers Focus Group Guide</h5>
            </div>
            <div class="card-body">
              <!-- ...existing guideCaregiver content... -->
              <!-- ...content omitted for brevity... -->
            </div>
          </div>
        </div>

        <!-- Recording Panel -->
        <div class="tab-pane fade" id="recordingPanel" role="tabpanel">
          <div class="recording-controls">
            <h4><i class="bi bi-record-circle me-2"></i>Recording Controls</h4>
            <p id="recordingStatus"><i class="bi bi-stop-circle"></i> Ready to record</p>
            <div class="d-flex flex-wrap justify-content-center">
              <button id="startRecording" class="recording-btn">
                <i class="bi bi-play-circle me-2"></i>Start Recording
              </button>
              <button id="stopRecording" class="recording-btn" disabled>
                <i class="bi bi-stop-circle me-2"></i>Stop Recording
              </button>
              <button id="downloadRecording" class="recording-btn" disabled>
                <i class="bi bi-download me-2"></i>Download Recording
              </button>
            </div>
          </div>
        </div>

        <!-- Notes Panel -->
        <div class="tab-pane fade" id="notesPanel" role="tabpanel">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Session Notes</h5>
            </div>
            <div class="card-body">
              <textarea id="sessionNotes" class="form-control" rows="8" placeholder="Record key observations, participant dynamics, emerging themes, and important quotes..."></textarea>
              <div class="text-end mt-3">
                <button id="downloadNotes" class="btn btn-outline-primary" disabled>
                  <i class="bi bi-download me-2"></i>Download Notes
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Branding & Contact Info -->
      <footer class="mt-5 pt-4 border-top text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <img src="/logo.png" alt="QualiData Logo" style="height:48px; margin-bottom:10px;">
        <div class="mb-2 fw-bold">QualiData Research Platform</div>
        <div id="metaInfo" class="mb-2"></div>
        <div class="mb-2">
          <span class="fw-semibold">PI:</span> Godsway Sackey &mdash; <a href="mailto:godswaysackey@gmail.com" style="color: #e3f2fd;">godswaysackey@gmail.com</a> &mdash; <a href="tel:+233269609634" style="color: #e3f2fd;">+233 26 960 9634</a>
        </div>
        <div class="mb-2">
          <span class="fw-semibold">Supervisor:</span> Prof. Frank Baiden (UHAS) &nbsp;|&nbsp; Dr. Stefan Konigorski (HPI)
        </div>
        <div class="mt-3 mb-2 small">&copy; 2025 QualiData Research Platform</div>
      </footer>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let participants = [];
    let eligibleParticipants = [];
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    // Visual option card selection logic (multi-select with feedback)
    let trustChoices = [];
    document.addEventListener('DOMContentLoaded', function() {
      const optionCards = document.querySelectorAll('.option-card');
      const counter = document.getElementById('trustChoiceCounter');
      const reasonsInput = document.getElementById('trustChoiceReasons');

      function updateVisuals() {
        let selected = 0;
        optionCards.forEach(card => {
          const overlay = card.querySelector('.checkmark-overlay');
          if (card.classList.contains('border-primary')) {
            card.classList.add('shadow-lg');
            card.style.background = 'rgba(40,167,69,0.08)';
            overlay.style.display = 'inline';
            selected++;
          } else {
            card.classList.remove('shadow-lg');
            card.style.background = '';
            overlay.style.display = 'none';
          }
        });
        counter.textContent = `${selected} selected`;
        counter.className = selected ? 'badge bg-success' : 'badge bg-primary';
      }

      optionCards.forEach(card => {
        card.addEventListener('click', function() {
          this.classList.toggle('border-primary');
          updateVisuals();
        });
      });
      updateVisuals();

      document.getElementById('saveTrustChoices').addEventListener('click', function() {
        trustChoices = [];
        optionCards.forEach(card => {
          if (card.classList.contains('border-primary')) {
            const option = card.getAttribute('data-option');
            trustChoices.push({ option });
          }
        });
        localStorage.setItem('fgd_trust_choices', JSON.stringify({ choices: trustChoices, reasons: reasonsInput.value.trim() }));
        document.getElementById('trustChoicesSaved').style.display = 'block';
        setTimeout(() => {
          document.getElementById('trustChoicesSaved').style.display = 'none';
        }, 2000);
      });

      document.getElementById('exportTrustChoices').addEventListener('click', function() {
        let exportText = 'FGD Trust Choices\n====================\n';
        trustChoices.forEach((choice, idx) => {
          exportText += `${idx+1}. ${choice.option.charAt(0).toUpperCase() + choice.option.slice(1)}\n`;
        });
        exportText += `\nReasons:\n${reasonsInput.value.trim() || 'None provided.'}`;
        const blob = new Blob([exportText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'fgd_trust_choices.txt';
        link.click();
        URL.revokeObjectURL(url);
      });
    });

    // Initialize form and FGD group logic
    document.addEventListener('DOMContentLoaded', function() {
      // Set current date/time
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('sessionDate').value = now.toISOString().slice(0, 16);

      // Set facilitator from stored profile
      const assistantDetails = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
      document.getElementById('facilitator').value = assistantDetails.fullName || 'Not set';

      // FGD group selection logic
      function showGuide(group) {
        document.getElementById('guidePatient').style.display = group === 'Patient' ? 'block' : 'none';
        document.getElementById('guideClinician').style.display = group === 'Clinician' ? 'block' : 'none';
        document.getElementById('guideHerbalist').style.display = group === 'Herbalist' ? 'block' : 'none';
        document.getElementById('guideCaregiver').style.display = group === 'Caregiver' ? 'block' : 'none';
      }
      const fgdGroup = document.getElementById('fgdGroup');
      showGuide(fgdGroup.value);
      fgdGroup.addEventListener('change', function() {
        showGuide(this.value);
      });

      // Footer meta info
      const metaInfo = document.getElementById('metaInfo');
      if (assistantDetails && assistantDetails.initials && assistantDetails.district && assistantDetails.hospital) {
        metaInfo.innerHTML = `<span class='fw-semibold'>RA:</span> ${assistantDetails.initials} &nbsp;|&nbsp; <span class='fw-semibold'>District:</span> ${assistantDetails.district} &nbsp;|&nbsp; <span class='fw-semibold'>Hospital:</span> ${assistantDetails.hospital}`;
      } else {
        metaInfo.innerHTML = `<span class='text-muted'>RA profile not set</span>`;
      }
    });

    // Generate filename
    function generateFilename() {
      const assistantDetails = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
      const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
      const initials = assistantDetails.initials || 'RA';
      
      return `FGD_${initials}_${date}`;
    }

    // Add participant
    function addParticipant() {
      const id = document.getElementById('participantId').value.trim();
      const age = document.getElementById('participantAge').value.trim();
      const gender = document.getElementById('participantGender').value;

      if (!id || !age || !gender) {
        alert('Please fill in all participant details');
        return;
      }

      const participant = { id, age, gender };
      participants.push(participant);
      updateParticipantsList();
      
      // Clear form
      document.getElementById('participantId').value = '';
      document.getElementById('participantAge').value = '';
      document.getElementById('participantGender').value = '';
    }

    // Update participants list
    function updateParticipantsList() {
      const list = document.getElementById('participantsList');
      if (participants.length === 0) {
        list.innerHTML = '<p class="text-muted">No participants added yet</p>';
        return;
      }

      list.innerHTML = participants.map((p, index) => `
        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
          <span><strong>${p.id}</strong> - ${p.age} years, ${p.gender}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="removeParticipant(${index})">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `).join('');
    }

    // Remove participant
    function removeParticipant(index) {
      participants.splice(index, 1);
      updateParticipantsList();
    }

    // Recording functionality
    const startRecordingButton = document.getElementById('startRecording');
    const stopRecordingButton = document.getElementById('stopRecording');
    const downloadRecordingButton = document.getElementById('downloadRecording');
    const recordingStatus = document.getElementById('recordingStatus');
    const downloadNotesButton = document.getElementById('downloadNotes');
    const sessionNotes = document.getElementById('sessionNotes');

    startRecordingButton.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.start();
        recordingStatus.innerHTML = '<i class="bi bi-record-circle text-danger"></i> Recording in progress...';
        startRecordingButton.disabled = true;
        startRecordingButton.classList.add('recording');
        stopRecordingButton.disabled = false;

        mediaRecorder.addEventListener('dataavailable', event => {
          audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener('stop', () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          audioChunks = [];
          recordingStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> Recording complete - Ready to download';
          startRecordingButton.disabled = false;
          startRecordingButton.classList.remove('recording');
          stopRecordingButton.disabled = true;
          downloadRecordingButton.disabled = false;
        });
      } catch (error) {
        recordingStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> Error accessing microphone';
        console.error('Error accessing microphone:', error);
      }
    });

    stopRecordingButton.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
    });

    downloadRecordingButton.addEventListener('click', () => {
      if (audioBlob) {
        const audioUrl = URL.createObjectURL(audioBlob);
        const downloadLink = document.createElement('a');
        downloadLink.href = audioUrl;
        downloadLink.download = `${generateFilename()}.wav`;
        downloadLink.click();
        URL.revokeObjectURL(audioUrl);
      }
    });

    sessionNotes.addEventListener('input', () => {
      downloadNotesButton.disabled = !sessionNotes.value.trim();
    });

    downloadNotesButton.addEventListener('click', () => {
      const sessionData = {
        date: document.getElementById('sessionDate').value,
        location: document.getElementById('sessionLocation').value,
        facilitator: document.getElementById('facilitator').value,
        participants: participants,
        notes: sessionNotes.value
      };

      const notesContent = `
FOCUS GROUP DISCUSSION SESSION NOTES
===================================

Date & Time: ${sessionData.date}
Location: ${sessionData.location}
Facilitator: ${sessionData.facilitator}
Number of Participants: ${participants.length}

PARTICIPANTS:
${participants.map(p => `- ${p.id} (${p.age} years, ${p.gender})`).join('\n')}

SESSION NOTES:
${sessionData.notes}

Generated by QualiData Research Platform
      `;

      const notesBlob = new Blob([notesContent], { type: 'text/plain' });
      const notesUrl = URL.createObjectURL(notesBlob);
      const downloadLink = document.createElement('a');
      downloadLink.href = notesUrl;
      downloadLink.download = `${generateFilename()}_notes.txt`;
      downloadLink.click();
      URL.revokeObjectURL(notesUrl);
    });

    // Load eligible participants from screening tracker
    function loadEligibleParticipants() {
      const allParticipants = JSON.parse(localStorage.getItem('qualidata_participants') || '[]');
      eligibleParticipants = allParticipants.filter(p => p.eligibilityChecklist?.eligibilityStatus === 'eligible');
      renderEligibleParticipants();
    }

    function renderEligibleParticipants() {
      const container = document.getElementById('eligibleParticipantsList');
      if (!eligibleParticipants.length) {
        container.innerHTML = '<p class="text-muted">No eligible participants found. Screen participants first.</p>';
        return;
      }
      // Group by type
      const typeOrder = ['Patient', 'Clinician', 'Herbalist', 'Policy Stakeholder', 'Caregiver'];
      const typeLabels = {
        'Patient': 'Patients',
        'Clinician': 'Clinicians',
        'Herbalist': 'Herbalists',
        'Policy Stakeholder': 'Policy Stakeholders',
        'Caregiver': 'Caregivers'
      };
      const typeColors = {
        'Patient': 'danger',
        'Clinician': 'primary',
        'Herbalist': 'success',
        'Policy Stakeholder': 'warning',
        'Caregiver': 'info'
      };
      let html = '';
      typeOrder.forEach(type => {
        const group = eligibleParticipants.filter(p => p.participantType === type);
        if (!group.length) return;
        html += `<h6 class="mt-3 mb-2 text-${typeColors[type]}">${typeLabels[type]}</h6>
          <div class="table-responsive mb-3">
            <table class="table table-bordered table-sm">
              <thead class="table-${typeColors[type]}">
                <tr>
                  <th>ID</th>
                  <th>Age</th>
                  <th>Gender</th>
                  <th>RA</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${group.map(p => `
                  <tr>
                    <td>${p.participantId}</td>
                    <td>${p.basicInfo?.ageRange || ''}</td>
                    <td>${p.basicInfo?.gender || ''}</td>
                    <td>${p.raInitials || ''}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-success" onclick="addEligibleToFGD('${p.participantId}')">
                        <i class="bi bi-plus-circle"></i> Add to FGD
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>`;
      });
      container.innerHTML = html;
    }

    window.addEligibleToFGD = function(participantId) {
      const p = eligibleParticipants.find(x => x.participantId === participantId);
      if (!p) return;
      // Prevent duplicates
      if (participants.some(x => x.id === p.participantId)) {
        alert('Participant already added to FGD attendance.');
        return;
      }
      // Use screening info for FGD attendance
      participants.push({
        id: p.participantId,
        age: p.basicInfo?.ageRange || p.basicInfo?.age || '',
        gender: p.basicInfo?.gender || ''
      });
      updateParticipantsList();
    };

    loadEligibleParticipants();
  </script>
</body>
</html>
