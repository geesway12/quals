<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2196f3">
  <title>Individual Interview - QualiData</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('assets/collaboration.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.1;
      z-index: -1;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      padding-top: 1rem;
      padding-bottom: 1rem;
      min-height: 80px;
    }

    .partner-logos {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
      margin-right: 2rem;
    }

    .partner-logos img {
      height: 36px;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .partner-logos img:hover {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .partner-logos {
        display: none;
      }
    }

    .main-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin: 2rem auto;
      padding: 2rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      max-width: 1200px;
    }

    .btn-back {
      background: linear-gradient(135deg, #6c757d, #495057);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      transform: scale(1.05);
      color: white;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .card-header {
      border-radius: 15px 15px 0 0 !important;
      border: none;
    }

    .recording-controls {
      background: linear-gradient(135deg, #ff5722, #d84315);
      color: white;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      margin: 2rem 0;
    }

    .recording-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      border-radius: 50px;
      padding: 1rem 2rem;
      margin: 0.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .recording-btn:hover {
      background: white;
      color: #ff5722;
    }

    .recording-btn.recording {
      background: #fff;
      color: #ff5722;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #2196f3;
      box-shadow: 0 0 0 0.25rem rgba(33, 150, 243, 0.25);
    }

    .btn-primary {
      background: linear-gradient(135deg, #2196f3, #1976d2);
      border: none;
      border-radius: 25px;
      padding: 0.75rem 2rem;
    }

    @media (max-width: 768px) {
      .main-content {
        margin: 1rem;
        padding: 1rem;
      }
      
      .recording-controls {
        padding: 1.5rem;
      }
      
      .recording-btn {
        display: block;
        width: 100%;
        margin: 0.5rem 0;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a href="index.html" class="btn-back me-3">
        <i class="bi bi-arrow-left me-2"></i>Back
      </a>
      <span class="navbar-brand fw-bold text-primary mb-0" id="navbarTitle">
        <i class="bi bi-mic me-2"></i>Individual Interview
      </span>
      
      <!-- Partner Logos -->
      <div class="partner-logos">
        <img src="assets/uhas.jpg" alt="UHAS" title="University of Health and Allied Sciences">
        <img src="assets/hpi.png" alt="HPI" title="Hasso Plattner Institute">
        <img src="assets/ghs.jpg" alt="GHS" title="Ghana Health Service">
        <img src="assets/cpmr.png" alt="CPMR" title="Centre for Plant Medicine Research">
      </div>
    </div>
  </nav>

  <div class="main-content" style="margin-top: 120px;">
    <div class="container-fluid">
      
      <!-- Participant Selection Section (shown when no participant is selected) -->
      <div id="participantSelectionContainer" class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-people me-2"></i>Select Eligible Participant for Interview</h5>
        </div>
        <div class="card-body">
          <div id="eligibleParticipantsList">
            <!-- Dynamic content will be populated here -->
          </div>
        </div>
      </div>
      
      <!-- Interview Interface Container -->
      <div id="interviewInterfaceContainer" style="display: none;">
        
        <!-- Interview Guide Section -->
        <div class="card mb-4" id="interviewQuestions">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-book me-2"></i>Individual Interview Guide (IDI)</h5>
        </div>
        <div class="card-body">
          <div class="accordion" id="interviewGuide">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#preparation">
                  <i class="bi bi-play-circle me-2"></i>Preparation & Introduction (5-10 mins)
                </button>
              </h2>
              <div id="preparation" class="accordion-collapse collapse show" data-bs-parent="#interviewGuide">
                <div class="accordion-body">
                  <h6 class="text-primary">Before Starting:</h6>
                  <ul class="mb-3">
                    <li>Ensure quiet, private environment</li>
                    <li>Test recording equipment</li>
                    <li>Review participant's eligibility criteria</li>
                    <li>Have consent forms ready if needed</li>
                  </ul>
                  <h6 class="text-primary">Opening Script:</h6>
                  <div class="alert alert-light">
                    <em>"Thank you for agreeing to participate in this interview. I am [Name] from [Institution]. This interview is part of a research study about digital health and hypertension management. The conversation will take about 60-90 minutes and will be recorded with your permission. Everything you share will be kept confidential, and you can stop the interview at any time. Do you have any questions before we begin?"</em>
                  </div>
                  <h6 class="text-primary">Key Points to Cover:</h6>
                  <ul>
                    <li><strong>Purpose:</strong> Understanding experiences with hypertension and digital health</li>
                    <li><strong>Duration:</strong> 60-90 minutes</li>
                    <li><strong>Confidentiality:</strong> All responses are confidential and anonymized</li>
                    <li><strong>Recording consent:</strong> Obtain verbal permission to record</li>
                    <li><strong>Right to withdraw:</strong> Can stop or pause at any time</li>
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#backgroundQuestions">
                  <i class="bi bi-person me-2"></i>Background & Warm-up (10-15 mins)
                </button>
              </h2>
              <div id="backgroundQuestions" class="accordion-collapse collapse" data-bs-parent="#interviewGuide">
                <div class="accordion-body">
                  <h6 class="text-success">Opening Questions:</h6>
                  <ol>
                    <li><strong>General Background:</strong>
                      <ul>
                        <li>"Can you tell me a bit about yourself and what you do?"</li>
                        <li>"How long have you been living in this area?"</li>
                      </ul>
                    </li>
                    <li><strong>Health Background:</strong>
                      <ul>
                        <li>"How would you describe your overall health?"</li>
                        <li>"When were you first diagnosed with high blood pressure?"</li>
                        <li>"What was that experience like for you?"</li>
                      </ul>
                    </li>
                    <li><strong>Technology Use:</strong>
                      <ul>
                        <li>"Do you use a smartphone or any digital devices regularly?"</li>
                        <li>"What do you typically use your phone for?"</li>
                      </ul>
                    </li>
                  </ol>
                  <div class="alert alert-info">
                    <strong>Interviewer Note:</strong> Use these questions to build rapport and understand the participant's context before moving to main topics.
                  </div>
                </div>
              </div>
            </div>

            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hypertensionManagement">
                  <i class="bi bi-heart-pulse me-2"></i>Hypertension Management Experience (20-25 mins)
                </button>
              </h2>
              <div id="hypertensionManagement" class="accordion-collapse collapse" data-bs-parent="#interviewGuide">
                <div class="accordion-body">
                  <h6 class="text-warning">Core Questions:</h6>
                  <ol>
                    <li><strong>Current Management:</strong>
                      <ul>
                        <li>"How do you currently manage your blood pressure?"</li>
                        <li>"What medications are you taking, if any?"</li>
                        <li>"Do you use any traditional or herbal remedies?"</li>
                        <li>"How often do you check your blood pressure?"</li>
                      </ul>
                    </li>
                    <li><strong>Healthcare Interactions:</strong>
                      <ul>
                        <li>"Tell me about your relationship with your healthcare providers"</li>
                        <li>"How often do you visit the clinic/hospital?"</li>
                        <li>"What are your experiences like during these visits?"</li>
                      </ul>
                    </li>
                    <li><strong>Challenges & Barriers:</strong>
                      <ul>
                        <li>"What are the biggest challenges you face in managing your blood pressure?"</li>
                        <li>"Are there times when it's difficult to take your medication?"</li>
                        <li>"What makes it hard to follow your treatment plan?"</li>
                      </ul>
                    </li>
                    <li><strong>Support Systems:</strong>
                      <ul>
                        <li>"Who helps you with managing your health?"</li>
                        <li>"What kind of support would be most helpful to you?"</li>
                      </ul>
                    </li>
                  </ol>
                  <div class="alert alert-warning">
                    <strong>Probing Questions:</strong>
                    <ul class="mb-0">
                      <li>"Can you tell me more about that?"</li>
                      <li>"What does that look like on a typical day?"</li>
                      <li>"How did that make you feel?"</li>
                      <li>"Can you give me an example?"</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#digitalHealth">
                  <i class="bi bi-phone me-2"></i>Digital Health & Technology (15-20 mins)
                </button>
              </h2>
              <div id="digitalHealth" class="accordion-collapse collapse" data-bs-parent="#interviewGuide">
                <div class="accordion-body">
                  <h6 class="text-info">Exploration Areas:</h6>
                  <ol>
                    <li><strong>Digital Health Awareness:</strong>
                      <ul>
                        <li>"What comes to mind when I say 'digital health' or 'health apps'?"</li>
                        <li>"Have you ever used any health-related apps or digital tools?"</li>
                        <li>"What have you heard about using technology for health?"</li>
                      </ul>
                    </li>
                    <li><strong>Attitudes & Perceptions:</strong>
                      <ul>
                        <li>"What would you think about using a smartphone app to help manage your blood pressure?"</li>
                        <li>"What would make you trust a health app?"</li>
                        <li>"What concerns would you have about using digital health tools?"</li>
                      </ul>
                    </li>
                    <li><strong>Preferences & Requirements:</strong>
                      <ul>
                        <li>"If you were to use a health app, what features would be most important to you?"</li>
                        <li>"How would you want your doctor to be involved with any app you use?"</li>
                        <li>"What would make an app easy for you to use?"</li>
                      </ul>
                    </li>
                    <li><strong>Barriers & Facilitators:</strong>
                      <ul>
                        <li>"What might prevent you from using a health app?"</li>
                        <li>"What would encourage you to try digital health tools?"</li>
                        <li>"How important is it that family members can be involved?"</li>
                      </ul>
                    </li>
                  </ol>
                </div>
              </div>
            </div>

            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nof1trials">
                  <i class="bi bi-graph-up me-2"></i>N-of-1 Trials & Personalized Medicine (10-15 mins)
                </button>
              </h2>
              <div id="nof1trials" class="accordion-collapse collapse" data-bs-parent="#interviewGuide">
                <div class="accordion-body">
                  <h6 class="text-primary">Concept Explanation:</h6>
                  <div class="alert alert-light">
                    <em>"N-of-1 trials are a way to find out which treatments work best for you personally. Instead of assuming one treatment works for everyone, you would try different treatments (like different medications or lifestyle changes) in a systematic way, tracking how you respond to each one. This helps identify what works best for your unique situation."</em>
                  </div>
                  <h6 class="text-primary">Discussion Points:</h6>
                  <ol>
                    <li><strong>Understanding & Interest:</strong>
                      <ul>
                        <li>"What do you think about this idea of personalizing your treatment?"</li>
                        <li>"How does this concept sound to you?"</li>
                        <li>"What questions do you have about this approach?"</li>
                      </ul>
                    </li>
                    <li><strong>Practical Considerations:</strong>
                      <ul>
                        <li>"What would you need to feel comfortable participating in something like this?"</li>
                        <li>"How important would it be to have your doctor involved?"</li>
                        <li>"What concerns would you have about trying this?"</li>
                      </ul>
                    </li>
                    <li><strong>Digital Integration:</strong>
                      <ul>
                        <li>"How do you feel about using an app to track your responses to different treatments?"</li>
                        <li>"What would make the tracking easy or difficult for you?"</li>
                      </ul>
                    </li>
                  </ol>
                </div>
              </div>
            </div>

            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cultural">
                  <i class="bi bi-people me-2"></i>Cultural & Social Context (10-15 mins)
                </button>
              </h2>
              <div id="cultural" class="accordion-collapse collapse" data-bs-parent="#interviewGuide">
                <div class="accordion-body">
                  <h6 class="text-success">Contextual Questions:</h6>
                  <ol>
                    <li><strong>Traditional & Modern Medicine:</strong>
                      <ul>
                        <li>"How do you view the relationship between traditional healing and modern medicine?"</li>
                        <li>"Do you use both traditional and modern treatments?"</li>
                        <li>"How do you decide which approach to use?"</li>
                      </ul>
                    </li>
                    <li><strong>Family & Community:</strong>
                      <ul>
                        <li>"How does your family view your health management?"</li>
                        <li>"What role do family members play in your health decisions?"</li>
                        <li>"How does your community view technology use for health?"</li>
                      </ul>
                    </li>
                    <li><strong>Trust & Authority:</strong>
                      <ul>
                        <li>"Who do you most trust for health advice?"</li>
                        <li>"How important is it that health tools are recommended by doctors?"</li>
                        <li>"What makes you trust a health intervention?"</li>
                      </ul>
                    </li>
                  </ol>
                </div>
              </div>
            </div>

            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wrap">
                  <i class="bi bi-check-circle me-2"></i>Wrap-up & Future Directions (5-10 mins)
                </button>
              </h2>
              <div id="wrap" class="accordion-collapse collapse" data-bs-parent="#interviewGuide">
                <div class="accordion-body">
                  <h6 class="text-danger">Closing Questions:</h6>
                  <ol>
                    <li><strong>Final Thoughts:</strong>
                      <ul>
                        <li>"Is there anything important about your health management that we haven't discussed?"</li>
                        <li>"What would you want researchers and healthcare providers to know about your experiences?"</li>
                      </ul>
                    </li>
                    <li><strong>Research Engagement:</strong>
                      <ul>
                        <li>"Would you be interested in participating in future research related to digital health?"</li>
                        <li>"How would you prefer to be contacted about future opportunities?"</li>
                      </ul>
                    </li>
                    <li><strong>Advice to Others:</strong>
                      <ul>
                        <li>"What advice would you give to someone newly diagnosed with high blood pressure?"</li>
                        <li>"What would you tell someone who is hesitant about using digital health tools?"</li>
                      </ul>
                    </li>
                  </ol>
                  <div class="alert alert-success">
                    <h6>Closing Script:</h6>
                    <em>"Thank you so much for sharing your experiences and insights with me today. Your perspectives are incredibly valuable for this research. Is there anything else you'd like to add or any questions you have for me? If you think of anything later, you can always contact us using the information provided. We will be in touch about next steps in the research, and we really appreciate your time and participation."</em>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

            <!-- Recording Controls -->
            <div class="card mb-4">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-mic me-2"></i>Recording Controls</h5>
              </div>
              <div class="card-body text-center">
                <div class="row">
                  <div class="col-12 col-md-6 mb-3">
                    <button id="startRecording" class="btn btn-success btn-lg w-100" disabled>
                      <i class="bi bi-play-circle me-2"></i>Start Recording
                    </button>
                  </div>
                  <div class="col-12 col-md-6 mb-3">
                    <button id="stopRecording" class="btn btn-danger btn-lg w-100" disabled>
                      <i class="bi bi-stop-circle me-2"></i>Stop Recording
                    </button>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <button id="downloadRecording" class="btn btn-primary btn-lg w-100" disabled>
                      <i class="bi bi-download me-2"></i>Download Recording
                    </button>
                  </div>
                </div>
                <div class="alert alert-info mt-3" role="alert">
                  <i class="bi bi-info-circle me-2"></i>
                  <span id="recordingStatus">Status: Select a participant to begin</span>
                </div>
              </div>
            </div>

            <!-- Interview Notes -->
            <div class="card mb-4">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Interview Notes</h5>
              </div>
              <div class="card-body">
                <textarea id="interviewNotes" class="form-control mb-3" placeholder="Type your notes here..." rows="8"></textarea>
                <button id="downloadNotes" class="btn btn-outline-primary w-100" disabled>
                  <i class="bi bi-download me-2"></i>Download Notes
                </button>
              </div>
            </div>

      </div> <!-- End of interviewInterfaceContainer -->

    </div>
  </div>

  <!-- Branding & Contact Info -->
  <footer class="mt-5 pt-4 border-top text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <img src="logo.png" alt="QualiData Logo" style="height:48px; margin-bottom:10px;">
    <div class="mb-2 fw-bold">QualiData Research Platform</div>
    <div id="metaInfo" class="mb-2"></div>
    <div class="mb-2">
      <span class="fw-semibold">PI:</span> Godsway Sackey &mdash; <a href="mailto:godswaysackey@gmail.com" style="color: #e3f2fd;">godswaysackey@gmail.com</a> &mdash; <a href="tel:+233269609634" style="color: #e3f2fd;">+233 26 960 9634</a>
    </div>
    <div class="mb-2">
      <span class="fw-semibold">Supervisor:</span> Prof. Frank Baiden (UHAS) &nbsp;|&nbsp; Dr. Stefan Konigorski (HPI)
    </div>
    <div class="mt-3 mb-2 small">&copy; 2025 QualiData Research Platform</div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let currentParticipant = null;
    let recordingStartTime = null;

    const startRecordingButton = document.getElementById('startRecording');
    const stopRecordingButton = document.getElementById('stopRecording');
    const downloadRecordingButton = document.getElementById('downloadRecording');
    const downloadNotesButton = document.getElementById('downloadNotes');
    const recordingStatus = document.getElementById('recordingStatus');
    const interviewNotes = document.getElementById('interviewNotes');

    // Data Management System Integration
    class InterviewManager {
      constructor() {
        this.participants = JSON.parse(localStorage.getItem('qualidata_participants') || '[]');
        this.sessions = JSON.parse(localStorage.getItem('qualidata_sessions') || '[]');
        this.loadCurrentParticipant();
        this.displayInterface();
        this.filterHospitalsByDistrict();
      }

      loadCurrentParticipant() {
        const participantData = localStorage.getItem('currentInterviewParticipant');
        if (participantData) {
          currentParticipant = JSON.parse(participantData);
        }
      }

      displayInterface() {
        if (currentParticipant) {
          this.showInterviewInterface();
        } else {
          this.showParticipantSelection();
        }
      }

      showParticipantSelection() {
        document.getElementById('participantSelectionContainer').style.display = 'block';
        document.getElementById('interviewInterfaceContainer').style.display = 'none';
        document.getElementById('navbarTitle').innerHTML = '<i class="bi bi-people me-2"></i>Select Participant for Interview';
        this.loadEligibleParticipants();
      }

      showInterviewInterface() {
        document.getElementById('participantSelectionContainer').style.display = 'none';
        document.getElementById('interviewInterfaceContainer').style.display = 'block';
        document.getElementById('navbarTitle').innerHTML = '<i class="bi bi-mic me-2"></i>Individual Interview';
        this.displayParticipantInfo();
        this.enableInterviewControls();
      }

      loadEligibleParticipants() {
        const eligibleParticipants = this.participants.filter(p => 
          p.eligibilityChecklist?.eligibilityStatus === 'eligible'
        );
        
        const container = document.getElementById('eligibleParticipantsList');
        
        if (eligibleParticipants.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi bi-people display-1"></i>
              <h5 class="mt-3">No eligible participants found</h5>
              <p>Screen participants first to build your eligible participant pool</p>
              <a href="screening-tracker.html" class="btn btn-primary">
                <i class="bi bi-person-plus me-2"></i>Go to Screening
              </a>
            </div>
          `;
          return;
        }

        // Group participants by type
        const typeOrder = ['Patient', 'Clinician', 'Herbalist', 'Policy Stakeholder', 'Caregiver'];
        const typeLabels = {
          'Patient': 'Patients',
          'Clinician': 'Clinicians', 
          'Herbalist': 'Herbalists',
          'Policy Stakeholder': 'Policy Stakeholders',
          'Caregiver': 'Caregivers'
        };
        const typeColors = {
          'Patient': 'danger',
          'Clinician': 'primary',
          'Herbalist': 'success',
          'Policy Stakeholder': 'warning',
          'Caregiver': 'info'
        };

        let html = '';
        
        typeOrder.forEach(type => {
          const group = eligibleParticipants.filter(p => p.participantType === type);
          if (group.length === 0) return;
          
          html += `
            <div class="participant-group mb-4">
              <h5 class="mt-3 mb-2 text-${typeColors[type]} d-flex align-items-center" style="cursor: pointer;" onclick="toggleGroup('${type}')">
                <i class="bi bi-chevron-down me-2" id="chevron-${type}"></i>${typeLabels[type]} (${group.length})
              </h5>
              <div id="group-${type}" class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead class="table-${typeColors[type]}">
                    <tr>
                      <th>Participant ID</th>
                      <th>Date of Contact</th>
                      <th>Date Enrolled</th>
                      <th>RA</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${group.map(participant => `
                      <tr>
                        <td><strong>${participant.participantId}</strong></td>
                        <td>${participant.dateOfContact ? new Date(participant.dateOfContact).toLocaleDateString() : ''}</td>
                        <td>${participant.dateEnrolled ? new Date(participant.dateEnrolled).toLocaleDateString() : 'Not enrolled'}</td>
                        <td>${participant.raInitials || ''}</td>
                        <td>
                          <button class="btn btn-${typeColors[type]} btn-sm" onclick="selectParticipantForInterview('${participant.participantId}')">
                            <i class="bi bi-mic me-1"></i>Start Interview
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      selectParticipant(participantId) {
        const participant = this.participants.find(p => p.participantId === participantId);
        if (participant) {
          // Set enrollment date when interview is started (if not already set)
          if (!participant.dateEnrolled) {
            participant.dateEnrolled = new Date().toISOString();
            
            // Update the participant in the array and save to localStorage
            const participantIndex = this.participants.findIndex(p => p.participantId === participantId);
            if (participantIndex !== -1) {
              this.participants[participantIndex] = participant;
              localStorage.setItem('qualidata_participants', JSON.stringify(this.participants));
            }
          }
          
          currentParticipant = participant;
          localStorage.setItem('currentInterviewParticipant', JSON.stringify(participant));
          this.showInterviewInterface();
        }
      }

      clearCurrentParticipant() {
        currentParticipant = null;
        localStorage.removeItem('currentInterviewParticipant');
        
        // Clear any existing participant info cards
        const existingCards = document.querySelectorAll('.container-fluid .card:not(#participantSelectionContainer):not(#interviewInterfaceContainer)');
        existingCards.forEach(card => card.remove());
        
        this.displayInterface();
      }

      // Render a scrollable participant table with group toggles
      renderSimpleParticipantTable() {
        const tableContainer = document.getElementById('participantTableContainer');
        if (!tableContainer) return;
        const participants = this.participants || [];
        let html = `<div style="max-height:350px; overflow-y:auto; border:1px solid #e9ecef; border-radius:10px;">
          <table class="table table-bordered table-striped mb-0">
            <thead class="table-primary">
              <tr>
                <th>Participant ID</th>
                <th>Date of Contact</th>
                <th>Date Enrolled</th>
                <th>RA</th>
              </tr>
            </thead>
            <tbody id="participantTableBody">`;
        // Default: show all
        for (const p of participants) {
          html += `<tr>
            <td>${p.participantId || ''}</td>
            <td>${p.dateOfContact || ''}</td>
            <td>${p.dateEnrolled || ''}</td>
            <td>${(JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}').initials) || ''}</td>
          </tr>`;
        }
        html += '</tbody></table></div>';
        tableContainer.innerHTML = html;
      }
    // ...existing code...
    // Add this container where you want the table to appear
    // <div id="participantTableContainer" class="mb-4"></div>
      // Duplicate constructor removed. Logic merged above.

      loadCurrentParticipant() {
        const participantData = localStorage.getItem('currentInterviewParticipant');
        if (participantData) {
          currentParticipant = JSON.parse(participantData);
        }
        this.filterHospitalsByDistrict();
      }
      // Hospital filtering logic
      filterHospitalsByDistrict() {
        const hospitalMap = {
          'Akwapim North': ['Tetteh Quarshie Memorial Hospital'],
          'Lower Manya-Krobo': ['St. Martin de Porres Catholic Hospital, Agomenya'],
          'Kwahu South': ['Kwahu Government Hospital'],
          'Suhum': ['Suhum District Hospital'],
          'Birim Central': ['Oda Government Hospital']
        };
        // Find hospital select element if present
        const hospitalSelect = document.querySelector('select[name="hospital"]');
        if (!hospitalSelect || !currentParticipant?.basicInfo?.district) return;
        const district = currentParticipant.basicInfo.district;
        const hospitals = hospitalMap[district] || [];
        hospitalSelect.innerHTML = hospitals.map(h => `<option value="${h}">${h}</option>`).join('');
      }

      displayParticipantInfo() {
        if (currentParticipant) {
          // Create a participant info card at the top
          const infoCard = document.createElement('div');
          infoCard.className = 'card mb-4';
          infoCard.innerHTML = `
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Current Participant</h5>
              <button class="btn btn-sm btn-light" onclick="changeParticipant()">
                <i class="bi bi-arrow-left me-1"></i>Change Participant
              </button>
            </div>
            <div class="card-body">
              <div class="alert alert-success">
                <div class="row">
                  <div class="col-md-6">
                    <strong><i class="bi bi-person-badge me-2"></i>Participant:</strong> ${currentParticipant.participantId}<br>
                    <strong><i class="bi bi-tag me-2"></i>Type:</strong> ${currentParticipant.participantType}
                  </div>
                  <div class="col-md-6">
                    <strong><i class="bi bi-calendar me-2"></i>Age:</strong> ${currentParticipant.basicInfo?.age || 'N/A'}<br>
                    <strong><i class="bi bi-gender-ambiguous me-2"></i>Gender:</strong> ${currentParticipant.basicInfo?.gender || 'N/A'}
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-12">
                    <strong><i class="bi bi-geo-alt me-2"></i>Location:</strong> ${currentParticipant.basicInfo?.district || 'N/A'}, ${currentParticipant.basicInfo?.hospital || 'N/A'}
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Insert the participant info card before the interview questions
          const container = document.getElementById('interviewInterfaceContainer');
          const interviewGuide = document.getElementById('interviewQuestions');
          container.insertBefore(infoCard, interviewGuide);
          // Show tailored interview prompts per group
          const interviewQuestionsCard = document.getElementById('interviewQuestions');
          if (currentParticipant.participantType === 'Patient' || currentParticipant.participantType === 'Hypertensive Patient') {
            interviewQuestionsCard.innerHTML = `
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-book me-2"></i>Hypertensive Patient Interview</h5>
              </div>
              <div class="card-body">
                <div class="mb-4">
                  <h6 class="text-primary">Objective:</h6>
                  <p>Understand patients’ experiences, treatment behaviours, and perspectives on integrating conventional and herbal care.</p>
                </div>
                <ol>
                  <li><strong>Diagnosis Experience:</strong><br>
                    Can you share the story of how you first found out you had high blood pressure? What symptoms or situations led you to seek help? Where did you go first, and how was the diagnosis explained to you?
                  </li>
                  <li><strong>Treatment History:</strong><br>
                    Since your diagnosis, what kinds of treatments have you tried? Can you list or describe any clinic-prescribed medicines, herbal remedies, or other forms of help you’ve used? What influenced your decisions to try each of them?
                  </li>
                  <li><strong>Perceptions and Beliefs:</strong><br>
                    How do you feel about your current treatment—whether it’s from the clinic, herbalist, or both? In your own view, what do you think causes high blood pressure or makes it worse?
                  </li>
                  <li><strong>Integration Perspectives:</strong><br>
                    If there was a system where you could use both clinic and herbal treatments in a coordinated way, how would you feel about that? Would you be open to trying personalised combinations of both types of care?
                  </li>
                  <li><strong>Daily Routines & Challenges:</strong><br>
                    What is your usual routine when it comes to taking your medications or herbs? Have you faced any difficulties—such as forgetting doses, side effects, or cost? Do you receive any support from family, health workers, or herbalists?
                  </li>
                </ol>
              </div>
            `;
          } else if (currentParticipant.participantType === 'Clinician') {
            interviewQuestionsCard.innerHTML = `
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-book me-2"></i>Clinician Interview</h5>
              </div>
              <div class="card-body">
                <div class="mb-4">
                  <h6 class="text-primary">Objective:</h6>
                  <p>Explore professional insights on treatment practices, patient behaviours, and openness to integrative strategies.</p>
                </div>
                <ol>
                  <li><strong>Current Practice:</strong><br>
                    Can you describe your typical approach to managing hypertension in your facility? What medications or advice do you commonly prescribe or give?
                  </li>
                  <li><strong>Observed Patient Behaviour:</strong><br>
                    Based on your experience, how do patients generally respond to treatment? Have you noticed any common behaviours such as missed appointments, reliance on herbs, or shared decision-making with family?
                  </li>
                  <li><strong>Attitudes Toward Integration:</strong><br>
                    What are your thoughts on incorporating herbal or traditional interventions alongside biomedical treatment for hypertension? What would make such integration acceptable or unacceptable to you?
                  </li>
                  <li><strong>System Constraints:</strong><br>
                    In your view, what challenges within the health system make it difficult to provide personalised or holistic care for hypertensive patients? Are there administrative, training, or resource-related limitations?
                  </li>
                  <li><strong>Digital Readiness:</strong><br>
                    Would you be interested in using digital platforms (such as mobile apps or personalised tracking tools) to monitor treatment outcomes for individual patients—especially if such tools supported both biomedical and herbal inputs?
                  </li>
                </ol>
              </div>
            `;
          } else if (currentParticipant.participantType === 'Herbalist' || currentParticipant.participantType === 'Herbal Practitioner') {
            interviewQuestionsCard.innerHTML = `
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-book me-2"></i>Herbal Practitioner Interview</h5>
              </div>
              <div class="card-body">
                <div class="mb-4">
                  <h6 class="text-primary">Objective:</h6>
                  <p>Capture knowledge of herbal care practices, patient patterns, and attitudes toward collaboration with biomedical care.</p>
                </div>
                <ol>
                  <li><strong>Common Treatments Used:</strong><br>
                    Can you explain the herbal remedies or specific herbs you often recommend to people with high blood pressure? How do you prepare them, and what advice do you give to clients on usage?
                  </li>
                  <li><strong>Client Demographics:</strong><br>
                    Who are the typical people who come to you for help with high blood pressure? What complaints or symptoms do they usually describe? Do they come directly to you or after trying something else?
                  </li>
                  <li><strong>Integration Readiness:</strong><br>
                    Would you be open to collaborating with hospitals or clinics in managing patients together? What kind of collaboration would you be comfortable with—referrals, shared records, co-treatment, or something else?
                  </li>
                  <li><strong>Beliefs About Conventional Care:</strong><br>
                    What are your personal views or experiences with clinic-based hypertension care? Do your clients ever talk to you about what happened at the hospital or the drugs they received?
                  </li>
                  <li><strong>Openness to Digital Tools:</strong><br>
                    Would you be open to recording basic information about your clients (such as age, symptoms, treatments used) using a paper or digital tool? Would you consider participating in a research study that tracks outcomes over time?
                  </li>
                </ol>
              </div>
            `;
          } else if (currentParticipant.participantType === 'Caregiver') {
            interviewQuestionsCard.innerHTML = `
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-book me-2"></i>Caregiver Interview</h5>
              </div>
              <div class="card-body">
                <div class="mb-4">
                  <h6 class="text-primary">Objective:</h6>
                  <p>Understand the role of caregivers in supporting hypertensive patients and their beliefs about treatment.</p>
                </div>
                <ol>
                  <li><strong>Care Role:</strong><br>
                    Can you describe your role in supporting the person with high blood pressure? What daily or weekly tasks do you help with?
                  </li>
                  <li><strong>Medication & Monitoring:</strong><br>
                    Do you assist with reminding the person to take their medicine or herbs? Have you helped observe or report any symptoms, side effects, or improvements to health workers or herbalists?
                  </li>
                  <li><strong>Beliefs About Treatment:</strong><br>
                    What do you personally believe about the medicines or herbs being used? Are you more supportive of clinic drugs, herbs, spiritual help, or a mix—and why?
                  </li>
                  <li><strong>Experience with Health System:</strong><br>
                    Have you ever interacted with health workers, nurses, herbalists, or community health volunteers on behalf of the patient? How was the experience?
                  </li>
                  <li><strong>Attitude Toward Integration:</strong><br>
                    If a doctor or herbalist suggested combining both hospital and herbal treatment approaches for your relative, would you be supportive? What would influence your acceptance or rejection of that?
                  </li>
                </ol>
              </div>
            `;
          }
        } else {
          // If no participant is selected, show a warning and redirect back
          const container = document.querySelector('.container-fluid');
          container.innerHTML = `
            <div class="alert alert-warning text-center">
              <i class="bi bi-exclamation-triangle display-1 mb-3"></i>
              <h4>No Participant Selected</h4>
              <p>Please select a participant from the screening tracker first.</p>
              <a href="screening-tracker.html" class="btn btn-primary">
                <i class="bi bi-arrow-left me-2"></i>Back to Screening
              </a>
            </div>
          `;
        }
      }

      enableInterviewControls() {
        if (currentParticipant) {
          startRecordingButton.disabled = false;
          downloadNotesButton.disabled = !interviewNotes.value.trim();
          recordingStatus.textContent = 'Status: Ready to record';
        } else {
          startRecordingButton.disabled = true;
          downloadNotesButton.disabled = true;
          recordingStatus.textContent = 'Status: Select a participant to begin';
        }
      }

      saveInterviewSession() {
        if (!currentParticipant) return null;

        const sessionData = {
          sessionId: this.generateSessionId(),
          participantId: currentParticipant.participantId,
          participantType: currentParticipant.participantType,
          type: 'IDI',
          date: new Date().toISOString(),
          duration: this.getRecordingDuration(),
          notes: interviewNotes.value.trim(),
          status: 'completed',
          location: currentParticipant.basicInfo?.district || 'Unknown',
          researcherId: this.getResearcherId()
        };

        this.sessions.push(sessionData);
        localStorage.setItem('qualidata_sessions', JSON.stringify(this.sessions));
        
        // Update participant record
        const participantIndex = this.participants.findIndex(p => p.participantId === currentParticipant.participantId);
        if (participantIndex !== -1) {
          this.participants[participantIndex].lastInterviewDate = sessionData.date;
          this.participants[participantIndex].interviewCount = (this.participants[participantIndex].interviewCount || 0) + 1;
          localStorage.setItem('qualidata_participants', JSON.stringify(this.participants));
        }

        return sessionData.sessionId;
      }

      generateSessionId() {
        const prefix = 'IDI';
        const count = this.sessions.filter(s => s.type === 'IDI').length + 1;
        return `${prefix}${count.toString().padStart(3, '0')}`;
      }

      getRecordingDuration() {
        if (recordingStartTime) {
          const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          return `${minutes}m ${seconds}s`;
        }
        return 'N/A';
      }

      getResearcherId() {
        const profile = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
        return profile.initials || 'Unknown';
      }
    }

    const interviewManager = new InterviewManager();

    // Global function to select participant for interview
    function selectParticipantForInterview(participantId) {
      interviewManager.selectParticipant(participantId);
    }

    // Global function to change participant
    function changeParticipant() {
      interviewManager.clearCurrentParticipant();
    }

    // Global function to toggle participant groups
    function toggleGroup(type) {
      const group = document.getElementById(`group-${type}`);
      const chevron = document.getElementById(`chevron-${type}`);
      
      if (group.style.display === 'none') {
        group.style.display = 'block';
        chevron.className = 'bi bi-chevron-down me-2';
      } else {
        group.style.display = 'none';
        chevron.className = 'bi bi-chevron-right me-2';
      }
    }

    function getFilename() {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
      const participantId = currentParticipant ? currentParticipant.participantId : 'unknown';
      const researcherId = interviewManager.getResearcherId();
      return `interview_${participantId}_${dateStr}_${timeStr}_${researcherId}`;
    }

    // Recording event listeners
    // Footer meta info logic
    document.addEventListener('DOMContentLoaded', function() {
      var assistantDetails = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
      var metaInfo = document.getElementById('metaInfo');
      if (metaInfo) {
        if (assistantDetails && assistantDetails.initials && assistantDetails.district && assistantDetails.hospital) {
          metaInfo.innerHTML = `<span class='fw-semibold'>RA:</span> ${assistantDetails.initials} &nbsp;|&nbsp; <span class='fw-semibold'>District:</span> ${assistantDetails.district} &nbsp;|&nbsp; <span class='fw-semibold'>Hospital:</span> ${assistantDetails.hospital}`;
        } else {
          metaInfo.innerHTML = `<span class='text-muted'>RA profile not set</span>`;
        }
      }
    });
    startRecordingButton.addEventListener('click', async () => {
      if (!currentParticipant) {
        alert('Please select a participant first');
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordingStartTime = Date.now();

        mediaRecorder.start();
        recordingStatus.innerHTML = '<i class="bi bi-record-circle text-danger"></i> Recording in progress...';
        startRecordingButton.disabled = true;
        startRecordingButton.classList.add('recording');
        stopRecordingButton.disabled = false;

        mediaRecorder.addEventListener('dataavailable', event => {
          audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener('stop', () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          audioChunks = [];
          recordingStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> Recording complete - Ready to download';
          startRecordingButton.disabled = false;
          startRecordingButton.classList.remove('recording');
          stopRecordingButton.disabled = true;
          downloadRecordingButton.disabled = false;
          
          // Save session data
          const sessionId = interviewManager.saveInterviewSession();
          if (sessionId) {
            console.log(`Interview session ${sessionId} saved successfully`);
          }
        });
      } catch (error) {
        recordingStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> Error accessing microphone';
        console.error('Error accessing microphone:', error);
        alert('Unable to access microphone. Please check your permissions.');
      }
    });

    stopRecordingButton.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
    });

    downloadRecordingButton.addEventListener('click', () => {
      if (audioBlob) {
        const audioUrl = URL.createObjectURL(audioBlob);
        const downloadLink = document.createElement('a');
        downloadLink.href = audioUrl;
        downloadLink.download = `${getFilename()}.wav`;
        downloadLink.click();
        URL.revokeObjectURL(audioUrl);
      }
    });

    interviewNotes.addEventListener('input', () => {
      downloadNotesButton.disabled = !interviewNotes.value.trim();
    });

    downloadNotesButton.addEventListener('click', () => {
      if (!currentParticipant) {
        alert('Please select a participant first');
        return;
      }

      const notesContent = `Interview Notes
Participant: ${currentParticipant.participantId}
Type: ${currentParticipant.participantType}
Date: ${new Date().toLocaleDateString()}
Researcher: ${interviewManager.getResearcherId()}

Notes:
${interviewNotes.value}`;

      const notesBlob = new Blob([notesContent], { type: 'text/plain' });
      const notesUrl = URL.createObjectURL(notesBlob);
      const downloadLink = document.createElement('a');
      downloadLink.href = notesUrl;
      downloadLink.download = `${getFilename()}_notes.txt`;
      downloadLink.click();
      URL.revokeObjectURL(notesUrl);
    });
  </script>
</body>
</html>
