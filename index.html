<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2196f3">
  <title>QualiData - Field Research Tool</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <style>
    :root {
      --primary-color: #2196f3;
      --secondary-color: #1976d2;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('assets/collaboration.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.1;
      z-index: -1;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      padding-top: 1rem;
      padding-bottom: 1rem;
      min-height: 80px;
    }

    .partner-logos {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
      margin-right: 2rem;
    }

    .partner-logos img {
      height: 36px;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .partner-logos img:hover {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .partner-logos {
        display: none;
      }
    }

    .hero-section {
      text-align: center;
      padding: 3rem 0;
      color: white;
    }

    .hero-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .hero-subtitle {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      opacity: 0.9;
    }

    .tool-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: none;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .tool-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .tool-card-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      text-align: center;
    }

    .tool-card-header.success {
      background: linear-gradient(135deg, var(--success-color), #388e3c);
    }

    .tool-card-header.warning {
      background: linear-gradient(135deg, var(--warning-color), #f57c00);
    }

    .tool-card-header.danger {
      background: linear-gradient(135deg, var(--danger-color), #d32f2f);
    }

    .tool-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .tool-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .tool-subtitle {
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .tool-card-body {
      padding: 1.5rem;
      text-align: center;
    }

    .btn-tool {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 25px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-tool:hover {
      transform: scale(1.05);
      color: white;
      box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
    }

    .offcanvas {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }

    .offcanvas-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
    }

    .list-group-item {
      border: none;
      background: transparent;
      padding: 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .list-group-item:hover {
      background: rgba(33, 150, 243, 0.1);
    }

    .container-main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .metric-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.8;
    }

    .metric-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .metric-label {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .hero-title {
        font-size: 2rem;
      }
      
      .hero-subtitle {
        font-size: 1rem;
      }
      
      .tool-card {
        margin-bottom: 1.5rem;
      }
      
      .metric-card {
        padding: 1rem;
      }
      
      .metric-number {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold text-primary" href="#">
        <i class="bi bi-clipboard-data me-2"></i>QualiData
        <span id="navbarProfileLabels" class="ms-2 small text-muted"></span>
      </a>
      
      <!-- Partner Logos -->
      <div class="partner-logos d-none d-md-flex">
        <img src="assets/uhas.jpg" alt="UHAS" title="University of Health and Allied Sciences">
        <img src="assets/hpi.png" alt="HPI" title="Hasso Plattner Institute">
        <img src="assets/ghs.jpg" alt="GHS" title="Ghana Health Service">
        <img src="assets/cpmr.png" alt="CPMR" title="Centre for Plant Medicine Research">
      </div>
      
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sideMenu">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </nav>

  <!-- Side Menu -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="sideMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">
        <i class="bi bi-gear me-2"></i>Menu
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="list-group list-group-flush">
        <a href="#" class="list-group-item list-group-item-action" onclick="showSettings()">
          <i class="bi bi-gear me-3"></i>
          <div>
            <div class="fw-semibold">Settings</div>
            <small class="text-muted">App configuration</small>
          </div>
        </a>
        <a href="#" class="list-group-item list-group-item-action" onclick="syncData()">
          <i class="bi bi-cloud-upload me-3"></i>
          <div>
            <div class="fw-semibold">Sync Data</div>
            <small class="text-muted">Upload to server</small>
          </div>
        </a>
        <a href="#" class="list-group-item list-group-item-action" onclick="showHelp()">
          <i class="bi bi-question-circle me-3"></i>
          <div>
            <div class="fw-semibold">Help & Support</div>
            <small class="text-muted">User guide and support</small>
          </div>
        </a>
        <a href="#" class="list-group-item list-group-item-action" onclick="exportData()">
          <i class="bi bi-download me-3"></i>
          <div>
            <div class="fw-semibold">Export Data</div>
            <small class="text-muted">Download all records</small>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main style="margin-top: 80px;">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container-main">
        <h1 class="hero-title">QualiData Research Platform</h1>
        <p class="hero-subtitle">Comprehensive mobile research toolkit for participant screening, interviews, and data collection</p>
        
        <!-- Research Metrics Dashboard -->
        <div class="row mt-4" id="researchMetrics">
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-primary">
              <div class="metric-icon"><i class="bi bi-people"></i></div>
              <div class="metric-number" id="totalParticipants">0</div>
              <div class="metric-label">Total Participants</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-success">
              <div class="metric-icon"><i class="bi bi-check-circle"></i></div>
              <div class="metric-number" id="eligibleParticipants">0</div>
              <div class="metric-label">Eligible</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-warning">
              <div class="metric-icon"><i class="bi bi-mic"></i></div>
              <div class="metric-number" id="completedInterviews">0</div>
              <div class="metric-label">Interviews Done</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-info">
              <div class="metric-icon"><i class="bi bi-journal"></i></div>
              <div class="metric-number" id="journalEntries">0</div>
              <div class="metric-label">Journal Entries</div>
            </div>
          </div>
        </div>
        
        <!-- Participant Type Breakdown -->
        <div class="row mt-3" id="participantTypeMetrics">
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-danger">
              <div class="metric-icon"><i class="bi bi-heart-pulse"></i></div>
              <div class="metric-number" id="patientCount">0</div>
              <div class="metric-label">Patients</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-primary">
              <div class="metric-icon"><i class="bi bi-hospital"></i></div>
              <div class="metric-number" id="clinicianCount">0</div>
              <div class="metric-label">Clinicians</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-success">
              <div class="metric-icon"><i class="bi bi-flower2"></i></div>
              <div class="metric-number" id="herbalistCount">0</div>
              <div class="metric-label">Herbalists</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-warning">
              <div class="metric-icon"><i class="bi bi-briefcase"></i></div>
              <div class="metric-number" id="policyStakeholderCount">0</div>
              <div class="metric-label">Policy Makers</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="metric-card bg-info">
              <div class="metric-icon"><i class="bi bi-person-heart"></i></div>
              <div class="metric-number" id="caregiverCount">0</div>
              <div class="metric-label">Caregivers</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tools Section -->
    <section class="py-5">
      <div class="container-main">
        <div class="row">
          <!-- Screening and Participant Management -->
          <div class="col-lg-6 col-md-6 mb-4">
            <div class="tool-card">
              <div class="tool-card-header">
                <i class="bi bi-people-fill tool-icon"></i>
                <h3 class="tool-title">Screening & Participant Management</h3>
                <p class="tool-subtitle">Comprehensive participant recruitment and tracking system</p>
              </div>
              <div class="tool-card-body">
                <a href="screening-tracker.html" class="btn-tool">
                  <i class="bi bi-play-circle me-2"></i>Access Tools
                </a>
              </div>
            </div>
          </div>

          <!-- Individual Interview -->
          <div class="col-lg-6 col-md-6 mb-4">
            <div class="tool-card">
              <div class="tool-card-header success">
                <i class="bi bi-mic-fill tool-icon"></i>
                <h3 class="tool-title">Individual Interview</h3>
                <p class="tool-subtitle">Professional interview conduct with guided questions and recording</p>
              </div>
              <div class="tool-card-body">
                <a href="interview.html" class="btn-tool">
                  <i class="bi bi-record-circle me-2"></i>Begin Interview
                </a>
              </div>
            </div>
          </div>

          <!-- Focus Group Discussion -->
          <div class="col-lg-6 col-md-6 mb-4">
            <div class="tool-card">
              <div class="tool-card-header warning">
                <i class="bi bi-chat-square-text-fill tool-icon"></i>
                <h3 class="tool-title">Focus Group Discussion</h3>
                <p class="tool-subtitle">Moderate group discussions with structured protocols</p>
              </div>
              <div class="tool-card-body">
                <a href="focus-group-discussion.html" class="btn-tool">
                  <i class="bi bi-people me-2"></i>Start Discussion
                </a>
              </div>
            </div>
          </div>

          <!-- Reflexive Journal -->
          <div class="col-lg-6 col-md-6 mb-4">
            <div class="tool-card">
              <div class="tool-card-header danger">
                <i class="bi bi-journal-text tool-icon"></i>
                <h3 class="tool-title">Reflexive Journal</h3>
                <p class="tool-subtitle">Post-interview reflection and quality documentation</p>
              </div>
              <div class="tool-card-body">
                <a href="reflexive-journal.html" class="btn-tool">
                  <i class="bi bi-pencil-square me-2"></i>Create Journal
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bootstrap JS -->
  <footer class="mt-5 pt-4 border-top text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <img src="logo.png" alt="QualiData Logo" style="height:48px; margin-bottom:10px;">
    <div class="mb-2 fw-bold">QualiData Research Platform</div>
    <div class="mb-2">
      <span class="fw-semibold">PI:</span> Godsway Sackey &mdash; <a href="mailto:godswaysackey@gmail.com" style="color: #e3f2fd;">godswaysackey@gmail.com</a> &mdash; <a href="tel:+233269609634" style="color: #e3f2fd;">+233 26 960 9634</a>
    </div>
    <div class="mb-2">
      <span class="fw-semibold">Supervisor:</span> Prof. Frank Baiden (UHAS) &nbsp;|&nbsp; Dr. Stefan Konigorski (HPI)
    </div>
    <div class="mt-3 mb-2 small">&copy; 2025 QualiData Research Platform. All rights reserved.</div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Data Management System
    class QualiDataManager {
      constructor() {
        this.loadData();
        this.updateMetrics();
      }

      loadData() {
        this.participants = JSON.parse(localStorage.getItem('qualidata_participants') || '[]');
        this.sessions = JSON.parse(localStorage.getItem('qualidata_sessions') || '[]');
        this.journals = JSON.parse(localStorage.getItem('qualidata_journals') || '[]');
        this.researcherProfile = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
      }

      saveData() {
        localStorage.setItem('qualidata_participants', JSON.stringify(this.participants));
        localStorage.setItem('qualidata_sessions', JSON.stringify(this.sessions));
        localStorage.setItem('qualidata_journals', JSON.stringify(this.journals));
      }

      updateMetrics() {
        // Count eligible participants correctly using the actual data structure
        const eligible = this.participants.filter(p => 
          p.eligibilityChecklist?.eligibilityStatus === 'eligible'
        ).length;
        
        // Count participants by type
        const patients = this.participants.filter(p => p.participantType === 'Patient').length;
        const clinicians = this.participants.filter(p => p.participantType === 'Clinician').length;
        const herbalists = this.participants.filter(p => p.participantType === 'Herbalist').length;
        const policyStakeholders = this.participants.filter(p => p.participantType === 'Policy Stakeholder').length;
        const caregivers = this.participants.filter(p => p.participantType === 'Caregiver').length;
        
        // Count interviews and sessions
        const interviews = this.sessions.filter(s => s.type === 'IDI' || s.type === 'FGD').length;
        
        // Update the displayed metrics
        document.getElementById('totalParticipants').textContent = this.participants.length;
        document.getElementById('eligibleParticipants').textContent = eligible;
        document.getElementById('completedInterviews').textContent = interviews;
        document.getElementById('journalEntries').textContent = this.journals.length;
        
        // Update participant type breakdown
        document.getElementById('patientCount').textContent = patients;
        document.getElementById('clinicianCount').textContent = clinicians;
        document.getElementById('herbalistCount').textContent = herbalists;
        document.getElementById('policyStakeholderCount').textContent = policyStakeholders;
        document.getElementById('caregiverCount').textContent = caregivers;
        
        // Add detailed breakdown in console for debugging
        console.log('Participant Analytics:', {
          total: this.participants.length,
          eligible: eligible,
          patients: patients,
          clinicians: clinicians,
          herbalists: herbalists,
          policyStakeholders: policyStakeholders,
          caregivers: caregivers,
          interviews: interviews,
          journals: this.journals.length
        });
      }

      addParticipant(participant) {
        participant.participantId = this.generateParticipantId(participant.participantType);
        participant.dateAdded = new Date().toISOString();
        this.participants.push(participant);
        this.saveData();
        this.updateMetrics();
        return participant.participantId;
      }

      generateParticipantId(type) {
        const prefix = {
          'Patient': 'PT',
          'Clinician': 'CL', 
          'Herbalist': 'HB',
          'Policy Stakeholder': 'PS'
        };
        const typeParticipants = this.participants.filter(p => p.participantType === type);
        const count = typeParticipants.length + 1;
        return `${prefix[type]}${count.toString().padStart(3, '0')}`;
      }
    }

    // Initialize data manager
    const dataManager = new QualiDataManager();

    // Menu functions
    function showSettings() {
      const modal = new bootstrap.Modal(document.getElementById('settingsModal') || createSettingsModal());
      modal.show();
    }

    function createSettingsModal() {
      const modalHtml = `
        <div class="modal fade" id="settingsModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Data Storage</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoSave" checked>
                    <label class="form-check-label" for="autoSave">Auto-save data</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Recording Quality</label>
                  <select class="form-select" id="recordingQuality">
                    <option value="high">High Quality</option>
                    <option value="medium" selected>Medium Quality</option>
                    <option value="low">Low Quality (smaller files)</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Profile Management</label>
                  <button class="btn btn-outline-primary w-100" onclick="editRAProfile()">
                    <i class="bi bi-person-gear me-2"></i>Edit RA Profile
                  </button>
                </div>
                <div class="mb-3">
                  <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                  <small class="text-muted d-block">This will delete all participants, interviews, and journals</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      return document.getElementById('settingsModal');
    }

    function clearAllData() {
      if (confirm('Are you sure? This will permanently delete ALL data including participants, interviews, and journals.')) {
        localStorage.removeItem('qualidata_participants');
        localStorage.removeItem('qualidata_sessions');
        localStorage.removeItem('qualidata_journals');
        localStorage.removeItem('participants'); // Legacy
        dataManager.loadData();
        dataManager.updateMetrics();
        alert('All data has been cleared.');
      }
    }

    function syncData() {
      alert('Data sync functionality will be implemented here. Currently all data is stored locally on this device.');
    }

    function showHelp() {
      window.open('https://wa.me/message/ELHL6MNXBJ2ZN1', '_blank');
    }

    function exportData() {
      if (dataManager.participants.length === 0) {
        alert('No data to export');
        return;
      }

      // Export all data: participants, sessions, journals, notes, audio
      let csvRows = [];
      // Participants
      csvRows.push('Participant ID,Type,Age,Gender,Date,Status,District,Hospital,Eligibility,RA Initials');
      dataManager.participants.forEach(p => {
        csvRows.push(`${p.participantId},${p.participantType},${p.basicInfo?.age || 'N/A'},${p.basicInfo?.gender || 'N/A'},${p.dateAdded?.split('T')[0] || 'N/A'},${p.status || 'screened'},${p.basicInfo?.district || 'N/A'},${p.basicInfo?.hospital || 'N/A'},${p.eligibilityStatus || 'pending'},${p.raInitials || 'N/A'}`);
      });
      // Sessions
      csvRows.push('\nSession ID,Type,Date,RA Initials,Group,Notes');
      (dataManager.sessions || []).forEach(s => {
        csvRows.push(`${s.sessionId || ''},${s.type || ''},${s.date || ''},${s.raInitials || ''},${s.group || ''},${s.notes || ''}`);
      });
      // Journals
      csvRows.push('\nJournal ID,Date,RA Initials,Entry');
      (dataManager.journals || []).forEach(j => {
        csvRows.push(`${j.journalId || ''},${j.date || ''},${j.raInitials || ''},"${(j.entry || '').replace(/"/g, '""')}"`);
      });
      // Notes (if stored in localStorage)
      const notes = JSON.parse(localStorage.getItem('qualidata_notes') || '[]');
      if (notes.length) {
        csvRows.push('\nNote ID,Date,RA Initials,Title,Content');
        notes.forEach(n => {
          csvRows.push(`${n.noteId || ''},${n.date || ''},${n.raInitials || ''},"${(n.title || '').replace(/"/g, '""')}","${(n.content || '').replace(/"/g, '""')}"`);
        });
      }
      // Audio recordings (if stored in localStorage)
      const audioFiles = JSON.parse(localStorage.getItem('qualidata_audio') || '[]');
      if (audioFiles.length) {
        csvRows.push('\nAudio File,Date,RA Initials,Group,Type');
        audioFiles.forEach(a => {
          csvRows.push(`${a.filename || ''},${a.date || ''},${a.raInitials || ''},${a.group || ''},${a.type || ''}`);
        });
      }
      // Create CSV
      const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `qualidata_export_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      alert(`Exported all data to CSV file. For audio/text files, see device storage or export separately.`);
    }

    function showRAProfileModal() {
      const modalHtml = `
        <div class="modal fade" id="raProfileModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-badge me-2"></i>Research Assistant Profile Setup</h5>
              </div>
              <div class="modal-body">
                <p class="mb-4">Please set up your research assistant profile to personalize the experience.</p>
                <form id="raProfileForm">
                  <div class="mb-3">
                    <label for="raInitials" class="form-label">Your Initials *</label>
                    <input type="text" class="form-control" id="raInitials" required maxlength="4" 
                           placeholder="e.g., GS" style="text-transform: uppercase;">
                    <div class="form-text">Used to identify your data entries</div>
                  </div>
                  <div class="mb-3">
                    <label for="raDistrict" class="form-label">Primary District *</label>
                    <select class="form-select" id="raDistrict" required>
                      <option value="">Select your primary district</option>
                      <option value="Akwapim North">Akwapim North</option>
                      <option value="Lower Manya-Krobo">Lower Manya-Krobo</option>
                      <option value="Kwahu South">Kwahu South</option>
                      <option value="Suhum">Suhum</option>
                      <option value="Birim Central">Birim Central</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="raHospital" class="form-label">Primary Hospital/Health Facility *</label>
                    <select class="form-select" id="raHospital" required>
                      <option value="">Select hospital/facility</option>
                    </select>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveRAProfile()">
                  <i class="bi bi-check-circle me-2"></i>Save Profile
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Set up district-hospital filtering
      document.getElementById('raDistrict').addEventListener('change', function() {
        updateHospitalOptions(this.value, 'raHospital');
      });
      
      // Make initials uppercase
      document.getElementById('raInitials').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
      
      const modal = new bootstrap.Modal(document.getElementById('raProfileModal'));
      modal.show();
    }

    function updateHospitalOptions(district, selectId) {
      const hospitalSelect = document.getElementById(selectId);
      const hospitalOptions = {
        'Akwapim North': [
          'Tetteh Quarshie Memorial Hospital',
          'Centre for Plant Medicine Research (CPMR), Mampong-Akwapim',
          'Other (specify in comments)'
        ],
        'Lower Manya-Krobo': [
          'St. Martin de Porres Catholic Hospital, Agomenya',
          'Other (specify in comments)'
        ],
        'Kwahu South': [
          'Kwahu Government Hospital',
          'Other (specify in comments)'
        ],
        'Suhum': [
          'Suhum District Hospital',
          'Other (specify in comments)'
        ],
        'Birim Central': [
          'Oda Government Hospital',
          'Other (specify in comments)'
        ],
        'Other': [
          'Other (specify in comments)'
        ]
      };
      
      hospitalSelect.innerHTML = '<option value="">Select hospital/facility</option>';
      if (hospitalOptions[district]) {
        hospitalOptions[district].forEach(hospital => {
          hospitalSelect.innerHTML += `<option value="${hospital}">${hospital}</option>`;
        });
      }
    }

    function saveRAProfile() {
      const form = document.getElementById('raProfileForm');
      const initials = document.getElementById('raInitials').value.trim();
      const district = document.getElementById('raDistrict').value;
      const hospital = document.getElementById('raHospital').value;
      
      if (!initials || !district || !hospital) {
        alert('Please fill in all required fields.');
        return;
      }
      
      const profileData = {
        initials: initials,
        district: district,
        hospital: hospital,
        setupDate: new Date().toISOString()
      };
      
      localStorage.setItem('researchAssistantDetails', JSON.stringify(profileData));
      
      // Update navbar
      let labelHtml = `<span class='fw-bold'>${initials}</span>`;
      labelHtml += ` | <span>${district}</span>`;
      labelHtml += ` | <span>${hospital}</span>`;
      document.getElementById('navbarProfileLabels').innerHTML = labelHtml;
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('raProfileModal'));
      modal.hide();
      
      // Remove modal from DOM
      setTimeout(() => {
        document.getElementById('raProfileModal').remove();
      }, 300);
      
      alert('Profile saved successfully!');
    }

    function editRAProfile() {
      // Close settings modal first
      const settingsModal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
      if (settingsModal) {
        settingsModal.hide();
      }
      
      // Show RA profile modal with current data
      const currentProfile = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
      
      const modalHtml = `
        <div class="modal fade" id="editRAProfileModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-gear me-2"></i>Edit RA Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="editRAProfileForm">
                  <div class="mb-3">
                    <label for="editRAInitials" class="form-label">Your Initials *</label>
                    <input type="text" class="form-control" id="editRAInitials" required maxlength="4" 
                           placeholder="e.g., GS" style="text-transform: uppercase;" value="${currentProfile.initials || ''}">
                  </div>
                  <div class="mb-3">
                    <label for="editRADistrict" class="form-label">Primary District *</label>
                    <select class="form-select" id="editRADistrict" required>
                      <option value="">Select your primary district</option>
                      <option value="Akwapim North" ${currentProfile.district === 'Akwapim North' ? 'selected' : ''}>Akwapim North</option>
                      <option value="Lower Manya-Krobo" ${currentProfile.district === 'Lower Manya-Krobo' ? 'selected' : ''}>Lower Manya-Krobo</option>
                      <option value="Kwahu South" ${currentProfile.district === 'Kwahu South' ? 'selected' : ''}>Kwahu South</option>
                      <option value="Suhum" ${currentProfile.district === 'Suhum' ? 'selected' : ''}>Suhum</option>
                      <option value="Birim Central" ${currentProfile.district === 'Birim Central' ? 'selected' : ''}>Birim Central</option>
                      <option value="Other" ${currentProfile.district === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="editRAHospital" class="form-label">Primary Hospital/Health Facility *</label>
                    <select class="form-select" id="editRAHospital" required>
                      <option value="">Select hospital/facility</option>
                    </select>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateRAProfile()">
                  <i class="bi bi-check-circle me-2"></i>Update Profile
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Set up district-hospital filtering
      document.getElementById('editRADistrict').addEventListener('change', function() {
        updateHospitalOptions(this.value, 'editRAHospital');
      });
      
      // Initialize hospital options and set current value
      if (currentProfile.district) {
        updateHospitalOptions(currentProfile.district, 'editRAHospital');
        setTimeout(() => {
          if (currentProfile.hospital) {
            document.getElementById('editRAHospital').value = currentProfile.hospital;
          }
        }, 100);
      }
      
      // Make initials uppercase
      document.getElementById('editRAInitials').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
      
      const modal = new bootstrap.Modal(document.getElementById('editRAProfileModal'));
      modal.show();
    }

    function updateRAProfile() {
      const initials = document.getElementById('editRAInitials').value.trim();
      const district = document.getElementById('editRADistrict').value;
      const hospital = document.getElementById('editRAHospital').value;
      
      if (!initials || !district || !hospital) {
        alert('Please fill in all required fields.');
        return;
      }
      
      const profileData = {
        initials: initials,
        district: district,
        hospital: hospital,
        setupDate: JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}').setupDate || new Date().toISOString(),
        lastUpdated: new Date().toISOString()
      };
      
      localStorage.setItem('researchAssistantDetails', JSON.stringify(profileData));
      
      // Update navbar
      let labelHtml = `<span class='fw-bold'>${initials}</span>`;
      labelHtml += ` | <span>${district}</span>`;
      labelHtml += ` | <span>${hospital}</span>`;
      document.getElementById('navbarProfileLabels').innerHTML = labelHtml;
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('editRAProfileModal'));
      modal.hide();
      
      // Remove modal from DOM
      setTimeout(() => {
        document.getElementById('editRAProfileModal').remove();
      }, 300);
      
      alert('Profile updated successfully!');
    }

    // Check if user profile exists and update UI
    window.addEventListener('load', function() {
      // Load and update metrics on page load
      dataManager.loadData();
      dataManager.updateMetrics();

      // Show RA profile setup modal if not registered
      const profile = localStorage.getItem('researchAssistantDetails');
      if (!profile) {
        showRAProfileModal();
      } else {
        // Show researcher initials, district, hospital in navbar
        const profileData = JSON.parse(profile);
        let labelHtml = '';
        if (profileData.initials) labelHtml += `<span class='fw-bold'>${profileData.initials}</span>`;
        if (profileData.district) labelHtml += ` | <span>${profileData.district}</span>`;
        if (profileData.hospital) labelHtml += ` | <span>${profileData.hospital}</span>`;
        document.getElementById('navbarProfileLabels').innerHTML = labelHtml;
      }
    });
  </script>
</body>
</html>
