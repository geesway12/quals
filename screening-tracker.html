<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2196f3">
  <title>Screening & Tracker - QualiData</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('assets/collaboration.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.1;
      z-index: -1;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      padding-top: 1rem;
      padding-bottom: 1rem;
      min-height: 80px;
    }

    .partner-logos {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: auto;
      margin-right: 2rem;
    }

    .partner-logos img {
      height: 36px;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .partner-logos img:hover {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .partner-logos {
        display: none;
      }
    }

    .main-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin: 2rem auto;
      padding: 2rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      max-width: 1200px;
    }

    .btn-back {
      background: linear-gradient(135deg, #6c757d, #495057);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      transform: scale(1.05);
      color: white;
    }

    .screening-wizard {
      display: none;
    }

    .screening-wizard.active {
      display: block;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .step {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 1rem;
      position: relative;
      transition: all 0.3s ease;
    }

    .step.active {
      background: #2196f3;
      color: white;
    }

    .step.completed {
      background: #4caf50;
      color: white;
    }

    .step::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: 2rem;
      height: 2px;
      background: #e9ecef;
      transform: translateY(-50%);
    }

    .step:last-child::after {
      display: none;
    }

    .step.completed::after {
      background: #4caf50;
    }

    .eligibility-checklist {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin: 1rem 0;
    }

    .criteria-item {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin: 0.5rem 0;
      border-left: 4px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .criteria-item.valid {
      border-left-color: #4caf50;
      background: #f1f8e9;
    }

    .criteria-item.invalid {
      border-left-color: #f44336;
      background: #ffebee;
    }

    .participant-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin: 1rem 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .participant-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .participant-header {
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
    }

    .participant-body {
      padding: 1rem;
    }

    .status-badge {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 15px;
    }

    .type-badge {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
    }

    @media (max-width: 768px) {
      .main-content {
        margin: 1rem;
        padding: 1rem;
      }
      
      .step-indicator {
        flex-wrap: wrap;
      }
      
      .step {
        margin: 0.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a href="index.html" class="btn-back me-3">
        <i class="bi bi-arrow-left me-2"></i>Back
      </a>
      <span class="navbar-brand fw-bold text-primary mb-0">
        <i class="bi bi-people me-2"></i>Screening & Tracker
      </span>
      
      <!-- Partner Logos -->
      <div class="partner-logos">
        <img src="assets/uhas.jpg" alt="UHAS" title="University of Health and Allied Sciences">
        <img src="assets/hpi.png" alt="HPI" title="Hasso Plattner Institute">
        <img src="assets/ghs.jpg" alt="GHS" title="Ghana Health Service">
        <img src="assets/cpmr.png" alt="CPMR" title="Centre for Plant Medicine Research">
      </div>
    </div>
  </nav>

  <div class="main-content" style="margin-top: 120px;">
    <div class="container-fluid">
      
      <!-- Quick Actions -->
      <div class="row mb-4">
        <div class="col-md-6">
          <button class="btn btn-primary btn-lg w-100" onclick="showScreeningWizard()">
            <i class="bi bi-person-plus me-2"></i>New Participant Screening
          </button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-outline-primary btn-lg w-100" onclick="showParticipantList()">
            <i class="bi bi-list me-2"></i>View All Participants
          </button>
        </div>
      </div>

      <!-- Screening Wizard -->
      <div id="screeningWizardContainer" class="screening-wizard">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Participant Screening Wizard</h5>
          </div>
          <div class="card-body">
            
            <!-- Step Indicator -->
            <div class="step-indicator">
              <div class="step active" id="step1">1</div>
              <div class="step" id="step2">2</div>
              <div class="step" id="step3">3</div>
              <div class="step" id="step4">4</div>
            </div>

            <!-- Step 1: Participant Type -->
            <div id="wizardStep1" class="wizard-step active">
              <h4 class="text-center mb-4">Select Participant Type</h4>
              <div class="row">
                <div class="col-md-6 col-lg-3 mb-3">
                  <div class="card h-100 participant-type-card" onclick="selectParticipantType('Patient')">
                    <div class="card-body text-center">
                      <i class="bi bi-heart-pulse display-4 text-danger mb-3"></i>
                      <h5>Patient</h5>
                      <p class="text-muted">Individuals with hypertension</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 col-lg-3 mb-3">
                  <div class="card h-100 participant-type-card" onclick="selectParticipantType('Clinician')">
                    <div class="card-body text-center">
                      <i class="bi bi-hospital display-4 text-primary mb-3"></i>
                      <h5>Clinician</h5>
                      <p class="text-muted">Healthcare professionals</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 col-lg-3 mb-3">
                  <div class="card h-100 participant-type-card" onclick="selectParticipantType('Herbalist')">
                    <div class="card-body text-center">
                      <i class="bi bi-flower2 display-4 text-success mb-3"></i>
                      <h5>Herbalist</h5>
                      <p class="text-muted">Traditional healers</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 col-lg-3 mb-3">
                  <div class="card h-100 participant-type-card" onclick="selectParticipantType('Policy Stakeholder')">
                    <div class="card-body text-center">
                      <i class="bi bi-briefcase display-4 text-warning mb-3"></i>
                      <h5>Policy Stakeholder</h5>
                      <p class="text-muted">Policy makers & regulators</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 col-lg-3 mb-3">
                  <div class="card h-100 participant-type-card" onclick="selectParticipantType('Caregiver')">
                    <div class="card-body text-center">
                      <i class="bi bi-person-heart display-4 text-info mb-3"></i>
                      <h5>Caregiver</h5>
                      <p class="text-muted">Support for patients</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 2: Basic Information -->
            <div id="wizardStep2" class="wizard-step" style="display: none;">
              <h4 class="text-center mb-4">Basic Information</h4>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="participantAgeRange" class="form-label">Age Range *</label>
                  <select class="form-select" id="participantAgeRange" required>
                    <option value="">Select age range</option>
                    <option value="18-24">18-24</option>
                    <option value="25-34">25-34</option>
                    <option value="35-44">35-44</option>
                    <option value="45-54">45-54</option>
                    <option value="55-64">55-64</option>
                    <option value="65+">65+</option>
                  </select>
                  <div class="form-text">Select age range (18+ only)</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="participantGender" class="form-label">Gender *</label>
                  <select class="form-select" id="participantGender" required>
                    <option value="">Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">District</label>
                  <input type="text" class="form-control" id="participantDistrict" readonly>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Hospital/Health Facility</label>
                  <input type="text" class="form-control" id="participantHospital" readonly>
                </div>
              </div>
              <div class="text-end">
                <button class="btn btn-outline-secondary me-2" onclick="previousStep()">Previous</button>
                <button class="btn btn-primary" onclick="nextStep()">Next</button>
              </div>
            </div>

            <!-- Step 3: Eligibility Checklist -->
            <div id="wizardStep3" class="wizard-step" style="display: none;">
              <h4 class="text-center mb-4">Eligibility Assessment</h4>
              <div id="eligibilityChecklist">
                <!-- Dynamic content based on participant type -->
              </div>
              <div class="text-end">
                <button class="btn btn-outline-secondary me-2" onclick="previousStep()">Previous</button>
                <button class="btn btn-primary" onclick="nextStep()">Next</button>
              </div>
            </div>

            <!-- Step 4: Review & Save -->
            <div id="wizardStep4" class="wizard-step" style="display: none;">
              <h4 class="text-center mb-4">Review & Save</h4>
              <div id="reviewSummary" class="eligibility-checklist">
                <!-- Summary will be populated here -->
              </div>
              <div class="text-end">
                <button class="btn btn-outline-secondary me-2" onclick="previousStep()">Previous</button>
                <button class="btn btn-success" onclick="saveParticipant()">
                  <i class="bi bi-check-circle me-2"></i>Save Participant
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Participants List -->
      <div id="participantsListContainer">
        <div class="card">
          <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Participant Database</h5>
            <div>
              <select class="form-select form-select-sm d-inline-block w-auto me-2" id="filterType">
                <option value="">All Types</option>
                <option value="Patient">Patients</option>
                <option value="Clinician">Clinicians</option>
                <option value="Herbalist">Herbalists</option>
                <option value="Policy Stakeholder">Policy Stakeholders</option>
                <option value="Caregiver">Caregivers</option>
              </select>
              <select class="form-select form-select-sm d-inline-block w-auto" id="filterStatus">
                <option value="">All Status</option>
                <option value="eligible">Eligible</option>
                <option value="not-eligible">Not Eligible</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div id="participantsList">
              <div class="text-center text-muted py-5">
                <i class="bi bi-people display-1"></i>
                <h5 class="mt-3">No participants yet</h5>
                <p>Start by screening your first participant</p>
                <button class="btn btn-primary" onclick="showScreeningWizard()">
                  <i class="bi bi-person-plus me-2"></i>Add First Participant
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Branding & Contact Info -->
  <footer class="mt-5 pt-4 border-top text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <img src="logo.png" alt="QualiData Logo" style="height:48px; margin-bottom:10px;">
    <div class="mb-2 fw-bold">QualiData Research Platform</div>
    <div id="metaInfo" class="mb-2"></div>
    <div class="mb-2">
      <span class="fw-semibold">PI:</span> Godsway Sackey &mdash; <a href="mailto:godswaysackey@gmail.com" style="color: #e3f2fd;">godswaysackey@gmail.com</a> &mdash; <a href="tel:+233269609634" style="color: #e3f2fd;">+233 26 960 9634</a>
    </div>
    <div class="mb-2">
      <span class="fw-semibold">Supervisor:</span> Prof. Frank Baiden (UHAS) &nbsp;|&nbsp; Dr. Stefan Konigorski (HPI)
    </div>
    <div class="mt-3 mb-2 small">&copy; 2025 QualiData Research Platform</div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Screening Wizard Controller
    class ScreeningWizard {
      constructor() {
        this.currentStep = 1;
        this.participantData = {};
        this.eligibilityCriteria = {};
        this.dataManager = window.parent?.dataManager || this.initDataManager();
        this.loadParticipants();
      }

      initDataManager() {
        return {
          participants: JSON.parse(localStorage.getItem('qualidata_participants') || '[]'),
          addParticipant: (participant) => {
            participant.participantId = this.generateParticipantId(participant.participantType);
            participant.dateOfContact = new Date().toISOString(); // Date form was filled
            participant.dateAdded = new Date().toISOString(); // Date record was created
            participant.dateEnrolled = null; // Will be set when interview is conducted
            participant.raInitials = this.getRAInitials();
            this.participants = JSON.parse(localStorage.getItem('qualidata_participants') || '[]');
            this.participants.push(participant);
            localStorage.setItem('qualidata_participants', JSON.stringify(this.participants));
            return participant.participantId;
          }
        };
      }

      nextStep() {
        if (this.currentStep === 2) {
          // Validate basic information
          const ageRange = document.getElementById('participantAgeRange').value;
          const gender = document.getElementById('participantGender').value;
          if (!ageRange || !gender) {
            alert('Please fill in all required fields.');
            return;
          }
          // Auto-assign district and hospital from RA profile
          const profile = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
          this.participantData.basicInfo = {
            ageRange: ageRange,
            gender: gender,
            district: profile.district || '',
            hospital: profile.hospital || ''
          };
          // Auto-fill district and hospital fields in the form
          document.getElementById('participantDistrict').value = profile.district || '';
          document.getElementById('participantHospital').value = profile.hospital || '';
          // Generate eligibility checklist for step 3
          this.generateEligibilityChecklist();
        }
        if (this.currentStep === 3) {
          // Validate eligibility criteria
          this.evaluateEligibility();
          this.generateReviewSummary();
        }
        if (this.currentStep < 4) {
          this.showStep(this.currentStep + 1);
        }
      }

      previousStep() {
        if (this.currentStep > 1) {
          this.showStep(this.currentStep - 1);
        }
      }

      generateEligibilityChecklist() {
        const criteria = this.getEligibilityCriteria(this.participantData.participantType);
        const container = document.getElementById('eligibilityChecklist');
        
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Eligibility Assessment for ${this.participantData.participantType}</strong><br>
            Please verify each criterion with the participant. All criteria marked as required must be met.
          </div>
        `;

        criteria.forEach(criterion => {
          const criteriaHtml = `
            <div class="criteria-item" id="criteria_${criterion.id}">
              <div class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                  <label class="form-label fw-semibold">${criterion.text}</label>
                  ${criterion.note ? `<div class="text-muted small">${criterion.note}</div>` : ''}
                </div>
                <div class="btn-group" role="group">
                  <input type="radio" class="btn-check" name="criteria_${criterion.id}" id="yes_${criterion.id}" value="yes">
                  <label class="btn btn-outline-success" for="yes_${criterion.id}">
                    <i class="bi bi-check"></i> Yes
                  </label>
                  
                  <input type="radio" class="btn-check" name="criteria_${criterion.id}" id="no_${criterion.id}" value="no">
                  <label class="btn btn-outline-danger" for="no_${criterion.id}">
                    <i class="bi bi-x"></i> No
                  </label>
                </div>
              </div>
              <div class="mt-2">
                <textarea class="form-control form-control-sm" placeholder="Comments (optional)" id="comment_${criterion.id}"></textarea>
              </div>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', criteriaHtml);
        });
      }

      evaluateEligibility() {
        const criteria = this.getEligibilityCriteria(this.participantData.participantType);
        let eligibleCount = 0;
        let totalRequired = 0;
        const results = {};

        criteria.forEach(criterion => {
          const value = document.querySelector(`input[name="criteria_${criterion.id}"]:checked`)?.value;
          const comment = document.getElementById(`comment_${criterion.id}`).value;
          
          results[criterion.id] = {
            value: value,
            comment: comment,
            text: criterion.text,
            required: criterion.required
          };

          if (criterion.required) {
            totalRequired++;
            if (value === 'yes') {
              eligibleCount++;
            }
          }

          // Update visual feedback
          const criteriaElement = document.getElementById(`criteria_${criterion.id}`);
          criteriaElement.classList.remove('valid', 'invalid');
          if (value === 'yes') {
            criteriaElement.classList.add('valid');
          } else if (value === 'no') {
            criteriaElement.classList.add('invalid');
          }
        });

        this.participantData.eligibilityChecklist = {
          criteriaResults: results,
          eligibilityStatus: eligibleCount === totalRequired ? 'eligible' : 'not-eligible',
          eligibilityReason: `Met ${eligibleCount} of ${totalRequired} required criteria`,
          assessedBy: JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}').initials || 'Unknown',
          assessmentDate: new Date().toISOString()
        };
      }

      generateReviewSummary() {
        const container = document.getElementById('reviewSummary');
        const data = this.participantData;
        
        const statusClass = data.eligibilityChecklist.eligibilityStatus === 'eligible' ? 'success' : 'danger';
        const statusIcon = data.eligibilityChecklist.eligibilityStatus === 'eligible' ? 'check-circle' : 'x-circle';
        
        container.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6><i class="bi bi-person me-2"></i>Participant Information</h6>
              <table class="table table-sm">
                <tr><td><strong>Type:</strong></td><td>${data.participantType}</td></tr>
                <tr><td><strong>Participant ID:</strong></td><td>${data.participantId || '[Will be generated]'}</td></tr>
                <tr><td><strong>RA Initials:</strong></td><td>${data.raInitials || '[Will be generated]'}</td></tr>
                <tr><td><strong>Age Range:</strong></td><td>${data.basicInfo.ageRange}</td></tr>
                <tr><td><strong>Gender:</strong></td><td>${data.basicInfo.gender}</td></tr>
                <tr><td><strong>District:</strong></td><td>${data.basicInfo.district || 'Not specified'}</td></tr>
                <tr><td><strong>Hospital:</strong></td><td>${data.basicInfo.hospital || 'Not specified'}</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6><i class="bi bi-clipboard-check me-2"></i>Eligibility Status</h6>
              <div class="alert alert-${statusClass} mb-3">
                <i class="bi bi-${statusIcon} me-2"></i>
                <strong>${data.eligibilityChecklist.eligibilityStatus.toUpperCase()}</strong><br>
                ${data.eligibilityChecklist.eligibilityReason}
              </div>
              <small class="text-muted">
                Assessed by: ${data.eligibilityChecklist.assessedBy}<br>
                Date: ${new Date(data.eligibilityChecklist.assessmentDate).toLocaleDateString()}
              </small>
            </div>
          </div>
        `;
      }

      saveParticipant() {
        try {
          const participantId = this.dataManager.addParticipant(this.participantData);
          
          // Show success message
          const alertType = this.participantData.eligibilityChecklist.eligibilityStatus === 'eligible' ? 'success' : 'warning';
          const message = this.participantData.eligibilityChecklist.eligibilityStatus === 'eligible' 
            ? `Participant ${participantId} has been saved and is eligible for the study!`
            : `Participant ${participantId} has been saved but is not eligible for the study.`;
            
          this.showAlert(message, alertType);
          
          // Reset wizard and show participants list
          setTimeout(() => {
            this.resetWizard();
            this.showParticipantList();
            this.loadParticipants();
          }, 2000);
          
        } catch (error) {
          this.showAlert('Error saving participant. Please try again.', 'danger');
          console.error('Save error:', error);
        }
      }

      showAlert(message, type) {
        const alertHtml = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
        document.querySelector('.main-content .container-fluid').insertAdjacentHTML('afterbegin', alertHtml);
      }

      resetWizard() {
        this.currentStep = 1;
        this.participantData = {};
        this.showStep(1);
        
        // Clear all form fields
        document.querySelectorAll('input, select, textarea').forEach(field => {
          if (field.type === 'radio' || field.type === 'checkbox') {
            field.checked = false;
          } else {
            field.value = '';
          }
        });
        
        // Reset visual states
        document.querySelectorAll('.participant-type-card').forEach(card => {
          card.classList.remove('border-primary', 'bg-light');
        });
      }

      loadParticipants() {
        const participants = JSON.parse(localStorage.getItem('qualidata_participants') || '[]');
        const container = document.getElementById('participantsList');
        const filterType = document.getElementById('filterType').value;
        const filterStatus = document.getElementById('filterStatus').value;

        // Apply filters
        let filtered = participants;
        if (filterType) {
          filtered = filtered.filter(p => p.participantType === filterType);
        }
        if (filterStatus) {
          if (filterStatus === 'eligible') {
            filtered = filtered.filter(p => p.eligibilityChecklist?.eligibilityStatus === 'eligible');
          } else if (filterStatus === 'not-eligible') {
            filtered = filtered.filter(p => p.eligibilityChecklist?.eligibilityStatus === 'not-eligible');
          }
        }

        // Group participants by type for tracker tables
        const typeOrder = ['Patient', 'Clinician', 'Herbalist', 'Policy Stakeholder', 'Caregiver'];
        const typeLabels = {
          'Patient': 'Patients',
          'Clinician': 'Clinicians',
          'Herbalist': 'Herbalists',
          'Policy Stakeholder': 'Policy Stakeholders',
          'Caregiver': 'Caregivers'
        };

        let html = '';
        // If a type filter is active, only show that group
        const typesToShow = filterType ? [filterType] : typeOrder;
        typesToShow.forEach(type => {
          const group = filtered.filter(p => p.participantType === type);
          html += `<h5 class="mt-4 mb-2">Participant ID Tracker â€“ ${typeLabels[type]}</h5>
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th>Participant ID</th>
                  <th>Date of Contact</th>
                  <th>Date Enrolled</th>
                  <th>RA</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${group.length === 0 ? `<tr><td colspan="5" class="text-muted">No ${typeLabels[type].toLowerCase()} yet</td></tr>` : group.map(participant => `
                  <tr>
                    <td>${participant.participantId}</td>
                    <td>${participant.dateOfContact ? new Date(participant.dateOfContact).toLocaleDateString() : ''}</td>
                    <td>${participant.dateEnrolled ? new Date(participant.dateEnrolled).toLocaleDateString() : 'Not enrolled'}</td>
                    <td>${participant.raInitials || ''}</td>
                    <td>
                      ${participant.eligibilityChecklist?.eligibilityStatus === 'eligible' ? `
                        <button class="btn btn-sm btn-success me-1" onclick="startInterview('${participant.participantId}')" title="Start Interview">
                          <i class="bi bi-mic"></i>
                        </button>
                      ` : ''}
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteParticipant('${participant.participantId}')" title="Delete">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`;
        });
        container.innerHTML = html;
      }

      selectParticipantType(type) {
        this.participantData.participantType = type;
        
        // Update visual selection
        document.querySelectorAll('.participant-type-card').forEach(card => {
          card.classList.remove('border-primary', 'bg-light');
        });
        event.target.closest('.participant-type-card').classList.add('border-primary', 'bg-light');
        
        // Auto-advance to next step after a short delay
        setTimeout(() => {
          this.showStep(2);
        }, 500);
      }

      showStep(stepNumber) {
        // Update step indicator
        document.querySelectorAll('.step').forEach((step, index) => {
          step.classList.remove('active', 'completed');
          if (index + 1 < stepNumber) {
            step.classList.add('completed');
          } else if (index + 1 === stepNumber) {
            step.classList.add('active');
          }
        });

        // Show/hide wizard steps
        document.querySelectorAll('.wizard-step').forEach((step, index) => {
          step.style.display = index + 1 === stepNumber ? 'block' : 'none';
        });

        this.currentStep = stepNumber;

        // On step 2, auto-fill district and hospital fields from RA profile
        if (stepNumber === 2) {
          const profile = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
          document.getElementById('participantDistrict').value = profile.district || '';
          document.getElementById('participantHospital').value = profile.hospital || '';
        }
      }

      getEligibilityCriteria(participantType) {
        const criteria = {
          'Patient': [
            { id: 'age18', text: 'Age 18 years or older', required: true },
            { id: 'hypertension', text: 'Diagnosed with hypertension', required: true },
            { id: 'consent', text: 'Able to provide informed consent', required: true },
            { id: 'communication', text: 'Able to communicate in English or local language', required: true }
          ],
          'Clinician': [
            { id: 'qualification', text: 'Licensed healthcare professional', required: true },
            { id: 'experience', text: 'Experience treating hypertension patients', required: true },
            { id: 'consent', text: 'Willing to participate in study', required: true }
          ],
          'Herbalist': [
            { id: 'practice', text: 'Active traditional healing practice', required: true },
            { id: 'hypertension_herbs', text: 'Experience with herbs for hypertension', required: true },
            { id: 'consent', text: 'Willing to share knowledge', required: true }
          ],
          'Policy Stakeholder': [
            { id: 'position', text: 'Role in health policy or regulation', required: true },
            { id: 'knowledge', text: 'Knowledge of traditional medicine policies', required: true },
            { id: 'consent', text: 'Willing to discuss policy matters', required: true }
          ],
          'Caregiver': [
            { id: 'caring', text: 'Currently caring for hypertension patient', required: true },
            { id: 'age18', text: 'Age 18 years or older', required: true },
            { id: 'consent', text: 'Able to provide informed consent', required: true }
          ]
        };
        return criteria[participantType] || [];
      }

      generateParticipantId(participantType) {
        const typePrefix = {
          'Patient': 'PAT',
          'Clinician': 'CLI',
          'Herbalist': 'HER',
          'Policy Stakeholder': 'POL',
          'Caregiver': 'CAR'
        };
        
        const prefix = typePrefix[participantType] || 'PAR';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substr(2, 2).toUpperCase();
        
        return `${prefix}${timestamp}${random}`;
      }

      getRAInitials() {
        const profile = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
        return profile.initials || 'RA';
      }
    }

    // Initialize wizard
    const wizard = new ScreeningWizard();

    // Global functions
    function showScreeningWizard() {
      document.getElementById('screeningWizardContainer').classList.add('active');
      document.getElementById('participantsListContainer').style.display = 'none';
      wizard.resetWizard();
    }

    function showParticipantList() {
      document.getElementById('screeningWizardContainer').classList.remove('active');
      document.getElementById('participantsListContainer').style.display = 'block';
      wizard.loadParticipants();
    }

    function selectParticipantType(type) {
      wizard.selectParticipantType(type);
    }

    function nextStep() {
      wizard.nextStep();
    }

    function previousStep() {
      wizard.previousStep();
    }

    function saveParticipant() {
      wizard.saveParticipant();
    }

    function startInterview(participantId) {
      const participants = JSON.parse(localStorage.getItem('qualidata_participants') || '[]');
      const participantIndex = participants.findIndex(p => p.participantId === participantId);
      
      if (participantIndex !== -1) {
        const participant = participants[participantIndex];
        
        // Set enrollment date when interview is started (if not already set)
        if (!participant.dateEnrolled) {
          participant.dateEnrolled = new Date().toISOString();
          participants[participantIndex] = participant;
          localStorage.setItem('qualidata_participants', JSON.stringify(participants));
        }
        
        localStorage.setItem('currentInterviewParticipant', JSON.stringify(participant));
        window.location.href = 'interview.html';
      }
    }

    function deleteParticipant(participantId) {
      if (confirm(`Are you sure you want to delete participant ${participantId}?`)) {
        let participants = JSON.parse(localStorage.getItem('qualidata_participants') || '[]');
        participants = participants.filter(p => p.participantId !== participantId);
        localStorage.setItem('qualidata_participants', JSON.stringify(participants));
        wizard.loadParticipants();
        wizard.showAlert(`Participant ${participantId} has been deleted.`, 'info');
      }
    }

    // Filter functionality
    document.getElementById('filterType').addEventListener('change', function() {
      // Filter implementation
      wizard.loadParticipants();
    });

    document.getElementById('filterStatus').addEventListener('change', function() {
      // Filter implementation  
      wizard.loadParticipants();
    });

    // Hospital filter by district
    function filterHospitalsByDistrict() {
      const district = document.getElementById('participantDistrict').value;
      const hospitalSelect = document.getElementById('participantHospital');
      const hospitalOptions = {
        'Akwapim North': [
          'Tetteh Quarshie Memorial Hospital',
          'Centre for Plant Medicine Research (CPMR), Mampong-Akwapim',
          'Other (specify in comments)'
        ],
        'Lower Manya-Krobo': [
          'St. Martin de Porres Catholic Hospital, Agomenya',
          'Other (specify in comments)'
        ],
        'Kwahu South': [
          'Kwahu Government Hospital',
          'Other (specify in comments)'
        ],
        'Suhum': [
          'Suhum District Hospital',
          'Other (specify in comments)'
        ],
        'Birim Central': [
          'Oda Government Hospital',
          'Other (specify in comments)'
        ],
        'Other': [
          'Other (specify in comments)'
        ]
      };
      hospitalSelect.innerHTML = '<option value="">Select hospital/facility</option>';
      if (hospitalOptions[district]) {
        hospitalOptions[district].forEach(hospital => {
          hospitalSelect.innerHTML += `<option value="${hospital}">${hospital}</option>`;
        });
      }
    }

    // Initialize view
    showParticipantList();

    // Footer meta info logic
    document.addEventListener('DOMContentLoaded', function() {
      var assistantDetails = JSON.parse(localStorage.getItem('researchAssistantDetails') || '{}');
      var metaInfo = document.getElementById('metaInfo');
      if (metaInfo) {
        if (assistantDetails && assistantDetails.initials && assistantDetails.district && assistantDetails.hospital) {
          metaInfo.innerHTML = `<span class='fw-semibold'>RA:</span> ${assistantDetails.initials} &nbsp;|&nbsp; <span class='fw-semibold'>District:</span> ${assistantDetails.district} &nbsp;|&nbsp; <span class='fw-semibold'>Hospital:</span> ${assistantDetails.hospital}`;
        } else {
          metaInfo.innerHTML = `<span class='text-muted'>RA profile not set</span>`;
        }
      }
    });
  </script>
</body>
  <!-- Removed duplicate footer meta info script -->
</html>